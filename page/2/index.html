<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.png" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.20/fancybox/fancybox.css" integrity="sha256-RvRHGSuWAxZpXKV9lLDt2e+rZ+btzn48Wp4ueS3NZKs=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ancao96.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"BFJCK79VF9","apiKey":"613fe5e83863193288c6ef2ab02cefad","indexName":"hexo","hits":{"per_page":10}}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="SCY SPACE">
<meta property="og:url" content="https://ancao96.github.io/page/2/index.html">
<meta property="og:site_name" content="SCY SPACE">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="SCY">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ancao96.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SCY SPACE</title>
    







<link rel="dns-prefetch" href="https://waline-server-nxpj3ksyo-scy.vercel.app">
    <noscript>
      <link rel="stylesheet" href="/css/noscript.css">
    </noscript>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.0.0/style.css">
    <style>
      body,div.post-body,h1,h2,h3,h4 {
        font-family: "LXGW WenKai LITE", sans-serif;
        font-size: 108%;
      }
    </style>
  </head>
  <body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
    <div class="headband"></div>
    <main class="main">
      <div class="column">
        <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">SCY SPACE</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">10</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">10</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">22</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
          
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="SCY" src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">SCY</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/AnCao96" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AnCao96" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ancao.cugb@gmail.com" title="E-Mail → mailto:ancao.cugb@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


      </div>
      <div class="main-inner index posts-expand">

    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/20/2023-8-20-11%E8%84%9A%E6%9C%AC%E3%80%81%E7%AE%97%E6%B3%95%E5%92%8C%E5%87%BD%E6%95%B0/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/20/2023-8-20-11%E8%84%9A%E6%9C%AC%E3%80%81%E7%AE%97%E6%B3%95%E5%92%8C%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">(11)脚本、算法和函数</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-20 09:14:20" itemprop="dateCreated datePublished" datetime="2023-08-20T09:14:20+08:00">2023-08-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-04 13:00:21" itemprop="dateModified" datetime="2023-10-04T13:00:21+08:00">2023-10-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/20/2023-8-20-11%E8%84%9A%E6%9C%AC%E3%80%81%E7%AE%97%E6%B3%95%E5%92%8C%E5%87%BD%E6%95%B0/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/20/2023-8-20-11%E8%84%9A%E6%9C%AC%E3%80%81%E7%AE%97%E6%B3%95%E5%92%8C%E5%87%BD%E6%95%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>26 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/algorithms">第十一章</a></p>
</blockquote>
<h1 id="前提条件">前提条件</h1>
<p>本章前提条件最小，因为它主要使用基础的R语言。<strong>sf</strong>包用于检查我们将开发的算法的结果，该算法用于计算多边形的面积。在先前知识方面，本章假设您了解在<em>空间数据</em>章中介绍的地理类以及它们如何用于表示各种各样的输入文件格式。</p>
<h1 id="引言">引言</h1>
<p><em>引言</em>章阐明了地理计算不仅仅是使用现有的工具，还包括以“可共享的R脚本和函数”的形式开发新工具。本章教授可复现代码的这些基础构件。它还介绍了低级几何算法，这种算法在<em>GIS</em>章中有应用。阅读本章应有助于您理解这类算法是如何工作的，并编写可多次、由多人、在多个数据集上使用的代码。然而，单凭本章自身无法使您成为一名熟练的程序员。编程是困难的，需要大量的实践：</p>
<blockquote>
<p>要理解编程作为一种自成体系的智力活动，您必须转向计算机编程；您必须阅读和编写计算机程序——很多程序。</p>
</blockquote>
<p>有充分的理由去学习编程。虽然本章本身并未教授编程——参见像@wickham_advanced_2019、<span class="citation" data-cites="gillespie_efficient_2016">@gillespie_efficient_2016</span>
和 <span class="citation" data-cites="xiao_gis_2016">@xiao_gis_2016</span>
这样的资源，它们教授R语言和其他语言的编程——但它确实提供了一些着眼于几何数据的起点，这些起点可能是发展编程技能的良好基础。</p>
<p>本章还演示并强调了可重复性的重要性。可重复性的优点不仅仅是允许其他人复制您的工作：相对于只运行一次的代码，可重复的代码在各方面通常都更优秀，包括计算效率、'可扩展性'（代码在大数据集上运行的能力）以及更容易进行适应和维护。</p>
<p>脚本是可重复R代码的基础，这一主题在<em>脚本</em>节中有覆盖。算法是一系列用于修改输入并得出输出的步骤的配方，如<em>几何算法</em>节所述。为了简化共享和可重复性，算法可以被放置在函数中。这是<em>函数</em>节的主题。找出多边形的质心的例子将用于整合这些概念。<em>几何操作</em>章已经介绍了一个质心函数<code>st_centroid()</code>，但这个例子突出显示了看似简单的操作其实是相对复杂代码的结果，这证实了以下的观察：</p>
<blockquote>
<p>关于空间数据问题最吸引人的一点是，对人来说看似极其简单的事情，在计算机上可能出奇地困难。</p>
</blockquote>
<p>这个例子也反映了本章的次要目标，即按照@xiao_gis_2016的说法，不是“复制现有的内容，而是展示现有内容是如何工作的”。</p>
<h1 id="脚本">脚本</h1>
<p>如果说包中分发的函数是R代码的基础构件，那么脚本就是将它们粘合在一起的胶水。脚本应该按照逻辑顺序存储和执行，以创建可复现的工作流，这可以手动完成，也可以使用诸如<strong>targets</strong>这样的工作流自动化工具来完成。</p>
<p>如果你是编程新手，当你第一次遇到脚本时，它们可能看起来很令人生畏，但实际上它们只是普通的文本文件。脚本通常保存为一个扩展名代表它们包含的语言的文件，例如，用Python编写的脚本使用<code>.py</code>扩展名，用Rust编写的脚本使用<code>.rs</code>扩展名。R脚本应该保存为<code>.R</code>扩展名，并且名字应该反映它们的功能。</p>
<p>一个例子是<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/geocompx/geocompr/blob/main/code/11-hello.R"><code>11-hello.R</code></a>，这是一个存储在书籍仓库的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/geocompx/geocompr/blob/main/code/"><code>code</code></a>文件夹中的脚本文件。<code>11-hello.R</code>是一个非常简单的脚本，只包含两行代码，其中一行是注释。</p>
<p>这些脚本通常是科研过程中非常有用的组成部分，特别是当你需要对大量栅格和矢量数据进行处理和后续分析时，它们可以帮助你实现高度自动化和可复现的工作流程。而使用例如<strong>targets</strong>这样的工作流工具，可以进一步提高代码的结构性和可维护性。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Aim: provide a minimal R script</span></span><br><span class="line">print<span class="punctuation">(</span><span class="string">&quot;Hello geocompr&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>这个脚本的内容并不特别令人兴奋，但它说明了一点：脚本不需要复杂。保存的脚本可以通过R命令行中的<code>source()</code>函数完整地调用和执行，如下面所示。这个命令的输出显示，注释会被忽略，但<code>print()</code>命令会被执行：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source<span class="punctuation">(</span><span class="string">&quot;code/11-hello.R&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; [1] &quot;Hello geocompr&quot;</span></span><br></pre></td></tr></table></figure>
<p>你也可以从系统命令行shell，例如<code>bash</code>和<code>PowerShell</code>，调用R脚本，前提是<code>RScript</code>可执行文件已经<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.reddit.com/r/Rlanguage/comments/zaovly/is_anybody_able_to_run_a_r_script_in_powershell/">配置</a>好，例如如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rscript code/11-hello.R</span><br></pre></td></tr></table></figure>
<p>关于脚本文件中可以和不能包含什么，并没有严格的规定，也没有什么能阻止你保存错误的、不可复制的代码。不包含有效R代码的代码行应该被注释掉，通过在行的开始处添加<code>#</code>，以防止错误，如<code>11-hello.R</code>脚本中的第一行所示。然而，有一些值得遵循的惯例：</p>
<ul>
<li>按顺序编写脚本：就像电影的剧本一样，脚本应该有一个明确的顺序，比如'设置'、'数据处理'和'保存结果'（大致相当于电影中的'开头'、'中间'和'结尾'）。</li>
<li>向脚本添加注释，以便其他人（以及你未来的自己）能够理解它。
至少，注释应该说明脚本的目的（见图@ref(fig:codecheck)）并（对于长脚本）将其划分为几个部分。
这可以在RStudio中通过快捷键<code>Ctrl+Shift+R</code>来完成，它会创建'可折叠'的代码段标题。</li>
<li>最重要的是，脚本应该是可复制的：能在任何计算机上运行的自包含脚本比只能在你的计算机上、在好天气下运行的脚本更有用。
这涉及到在开始时附加所需的包，从持久性来源（如可靠网站）读取数据，并确保已经采取了之前的步骤。<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
</ul>
<p>在R脚本中强制可复制性是困难的，但有一些工具可以帮助。默认情况下，RStudio
会'代码检查' R脚本，并用红色波浪线标出有问题的代码，如下图所示：</p>
<p><img data-src="https://scy11.oss-cn-beijing.aliyuncs.com/img/202309051045079.png">
Code checking in RStudio. This example, from the script
11-centroid-alg.R, highlights an unclosed curly bracket on line 19.</p>
<blockquote>
<p>📌A useful tool for reproducibility is the <strong>reprex</strong>
package. Its main function <code>reprex()</code> tests lines of R code
to check if they are reproducible, and provides markdown output to
facilitate communication on sites such as GitHub. See the web page
reprex.tidyverse.org for details.</p>
</blockquote>
<p>本节的内容适用于任何类型的R脚本。对于地理计算脚本的特殊考虑是，它们往往具有外部依赖性，例如在第@ref(read-write)章中重度使用的用于处理地理数据的核心R包所需的GDAL依赖，用于数据导入和导出。运行更专业的地理算法可能需要GIS软件依赖，如第十章所概述。处理地理数据的脚本还常常要求输入数据集以特定格式提供。这种依赖应在脚本的注释中或其所属项目的其他地方进行说明，如脚本
<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/geocompx/geocompr/blob/main/code/11-centroid-alg.R"><code>11-centroid-alg.R</code></a>
所示。'防御性'
编程技巧和良好的错误信息可以通过检查依赖性和与用户沟通（如果某些需求未得到满足）来节省时间。如果语句，用R中的<code>if ()</code>实现，可用于发送消息或运行代码行，只有在满足某些条件时才会这样做。例如，以下代码行会在缺少某个文件时向用户发送消息：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span>file.exists<span class="punctuation">(</span><span class="string">&quot;required_geo_data.gpkg&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  message<span class="punctuation">(</span><span class="string">&quot;No file, required_geo_data.gpkg is missing!&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line"><span class="comment">#&gt; No file, required_geo_data.gpkg is missing!</span></span><br></pre></td></tr></table></figure>
<p><code>11-centroid-alg.R</code>脚本所进行的工作在下面的可复制示例中有所展示，该示例创建了一个名为<code>poly_mat</code>的预备对象，代表一个边长为9单位的正方形。这个例子显示了<code>source()</code>可以与URLs一同工作，假设你有互联网连接。如果没有，相同的脚本可以通过<code>source("code/11-centroid-alg.R")</code>来调用，前提是你之前已经下载了<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/geocompx/geocompr">github.com/geocompx/geocompr</a>仓库，并且你正在<code>geocompr</code>文件夹中运行R。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">poly_mat <span class="operator">=</span> cbind<span class="punctuation">(</span></span><br><span class="line">  x <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">9</span><span class="punctuation">,</span> <span class="number">9</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  y <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">9</span><span class="punctuation">,</span> <span class="number">9</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># Short URL to code/11-centroid-alg.R in the geocompr repo</span></span><br><span class="line">source<span class="punctuation">(</span><span class="string">&quot;https://t.ly/0nzj&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#&gt; [1] &quot;The area is: 81&quot;</span><br><span class="line">#&gt; [1] &quot;The coordinates of the centroid are: 4.5, 4.5&quot;</span><br></pre></td></tr></table></figure>
<h1 id="几何算法">几何算法</h1>
<p>我们可以这么理解算法，它相当于烘焙食谱。它们是一整套指导方针，当对输入进行操作时，会得到有用/美味的结果。输入在烘焙的情况下是如面粉和糖的成分，在算法的情况下是数据和输入参数。而烘焙食谱可能导致美味的蛋糕，成功的算法应有带来环境/社会/其他利益的计算结果。在深入可复制示例之前，下面简短的历史将展示算法是如何与脚本（在<em>脚本</em>节中涉及）和函数（可以用来概括算法，使其更便携和易于使用，我们将在<em>函数</em>节中看到）相关联的。</p>
<p>"算法"这个词源自9世纪在巴格达出版的早期数学教科书 <em>Hisab al-jabr
w’al-muqabala</em>。这本书被译成拉丁文，并变得非常流行，以至于作者的姓氏，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Muhammad_ibn_Musa_al-Khwarizmi">al-Khwārizmī</a>，“被永久地当作一个科学术语来记忆：Al-Khwarizmi
变成了 Alchoarismi、Algorismi，最终变成了 algorithm” <span class="citation" data-cites="bellos_alex_2011">[@bellos_alex_2011]</span>。在计算时代，算法指的是解决问题的一系列步骤，从而得出预定义的输出。输入必须在适当的数据结构中正式定义<span class="citation" data-cites="wise_gis_2001">[@wise_gis_2001]</span>。算法通常从流程图或伪代码开始，展示过程的目标，然后在代码中实现。为了简化可用性，常见的算法通常被封装在函数内，这些函数可能会隐藏一些或所有已采取的步骤（除非你查看函数的源代码，参见<em>函数</em>节）。</p>
<p>地理算法，比如我们在<em>GIS</em>章节中遇到的，是接收地理数据并通常返回地理结果的算法（同样的东西还有其他术语，比如<em>GIS算法</em>和<em>几何算法</em>）。这可能听起来简单，但这是一个深刻的主题，有一个专门的学术领域，<em>计算几何</em>，致力于它们的研究<span class="citation" data-cites="berg_computational_2008">[@berg_computational_2008]</span>，以及关于该主题的大量书籍。<span class="citation" data-cites="orourke_computational_1998">@orourke_computational_1998</span>，例如，使用可复制和免费提供的C代码，以一系列逐渐复杂的几何算法介绍该主题。</p>
<p>几何算法的一个例子是找出多边形的质心的算法。有许多方法来计算质心，其中一些仅适用于特定类型的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Centroid">空间数据</a>。为了本节的目的，我们选择一种容易可视化的方法：将多边形分解成许多三角形，并找出每个三角形的质心，这种方法由
<span class="citation" data-cites="kaiser_algorithms_1993">@kaiser_algorithms_1993</span>
讨论，还简短地在 <span class="citation" data-cites="orourke_computational_1998">@orourke_computational_1998</span>
中提到。在编写任何代码之前，进一步将这种方法分解成离散任务会有所帮助（后来称为步骤1到步骤4，这些也可以以示意图或伪代码的形式呈现）：</p>
<ol type="1">
<li>将多边形分成相邻的三角形。</li>
<li>找出每个三角形的质心。</li>
<li>找出每个三角形的面积。</li>
<li>找出三角形质心的面积加权平均值。</li>
</ol>
<p>这些步骤可能听起来很简单，但将单词转换成工作代码需要一些工作和大量的反复试验，即使输入有限制：算法仅适用于<em>凸多边形</em>，它们不包含大于180°的内角，不允许星形（<strong>decido</strong>和<strong>sfdct</strong>软件包可以使用外部库对非凸多边形进行三角剖分，如<a target="_blank" rel="external nofollow noopener noreferrer" href="https://geocompx.github.io/geocompkg/articles/algorithm.html">algorithm</a>
小册子中所示，该小册子托管在 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://geocompx.org/">geocompx.org</a> 上）。</p>
<p>表示多边形最简单的数据结构是一个矩阵，其中x和y坐标在每行表示一个顶点，以追踪多边形边界的顺序，其中第一行和最后一行是相同的<span class="citation" data-cites="wise_gis_2001">[@wise_gis_2001]</span>。在这种情况下，我们将用基础的R创建一个有五个顶点的多边形，该多边形建立在<em>GIS
Algorithms</em> <span class="citation" data-cites="xiao_gis_2016参见">[@xiao_gis_2016参见[github.com/gisalgs](https://github.com/gisalgs/geom)
以获取 Python 代码]</span>的一个示例上，如下图所示。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># generate a simple matrix representation of a polygon:</span></span><br><span class="line">x_coords <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span> <span class="number">20</span><span class="punctuation">,</span> <span class="number">12</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span></span><br><span class="line">y_coords <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">15</span><span class="punctuation">,</span> <span class="number">20</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">poly_mat <span class="operator">=</span> cbind<span class="punctuation">(</span>x_coords<span class="punctuation">,</span> y_coords<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>现在我们有了一个示例数据集，我们准备进行上面概述的第1步。下面的代码展示了通过创建一个单一的三角形（<code>T1</code>）来实现这一点，该代码演示了该方法；它还通过基于<a target="_blank" rel="external nofollow noopener noreferrer" href="https://math.stackexchange.com/a/1702606">公式</a><span class="math inline">\(1/3(a + b + c)\)</span>
来计算其质心，从而演示了第2步，其中<span class="math inline">\(a\)</span>到<span class="math inline">\(c\)</span>是表示三角形顶点的坐标：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create a point representing the origin:</span></span><br><span class="line">Origin <span class="operator">=</span> poly_mat<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line"><span class="comment"># create &#x27;triangle matrix&#x27;:</span></span><br><span class="line">T1 <span class="operator">=</span> rbind<span class="punctuation">(</span>Origin<span class="punctuation">,</span> poly_mat<span class="punctuation">[</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">,</span> Origin<span class="punctuation">)</span> </span><br><span class="line">C1 <span class="operator">=</span> <span class="punctuation">(</span>T1<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span> <span class="operator">+</span> T1<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span><span class="punctuation">]</span> <span class="operator">+</span> T1<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://scy11.oss-cn-beijing.aliyuncs.com/img/202309051050278.png">
Illustration of polygon centroid calculation problem.</p>
<p>第3步是找出每个三角形的面积，以便计算一个<em>加权平均值</em>，该值会考虑到大三角形的不成比例影响。计算三角形面积的公式如下<span class="citation" data-cites="kaiser_algorithms_1993">[@kaiser_algorithms_1993]</span>：</p>
<p><span class="math display">\[
\frac{A_x ( B_y − C_y ) + B_x ( C_y − A_y ) + C_x ( A_y − B_y )}{ 2 }
\]</span></p>
<p>式中，<span class="math inline">\(A\)</span>到<span class="math inline">\(C\)</span>是三角形的三个点，而<span class="math inline">\(x\)</span>和<span class="math inline">\(y\)</span>分别指代 x 和 y
的维度。将这个公式翻译成能够处理矩阵表示形式的三角形 <code>T1</code>
数据的 R 代码如下（函数 <code>abs()</code> 确保了结果为正）：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># calculate the area of the triangle represented by matrix T1:</span></span><br><span class="line"><span class="built_in">abs</span><span class="punctuation">(</span>T1<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="punctuation">(</span>T1<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> T1<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    T1<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="punctuation">(</span>T1<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> T1<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    T1<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="punctuation">(</span>T1<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> T1<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="number">2</span></span><br><span class="line"><span class="comment">#&gt; [1] 85</span></span><br></pre></td></tr></table></figure>
<p>该代码块输出了正确的结果。<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>问题在于代码比较笨拙，如果我们想要在另一个三角形矩阵上运行它，就必须重新键入。为了使代码更具通用性，我们将在<em>函数</em>节中看到如何将其转换为一个函数。</p>
<p>第4步要求在所有三角形上（如上面所示），而不仅仅是一个三角形上，进行第2步和第3步。这就需要<em>迭代</em>以创建表示多边形的所有三角形，如下图所示。这里使用
<code>lapply()</code>和
<code>vapply()</code>来迭代每个三角形，因为它们在基础 R
中提供了一个简洁的解决方案：<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">i <span class="operator">=</span> <span class="number">2</span><span class="operator">:</span><span class="punctuation">(</span>nrow<span class="punctuation">(</span>poly_mat<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line">T_all <span class="operator">=</span> lapply<span class="punctuation">(</span>i<span class="punctuation">,</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  rbind<span class="punctuation">(</span>Origin<span class="punctuation">,</span> poly_mat<span class="punctuation">[</span>x<span class="operator">:</span><span class="punctuation">(</span>x <span class="operator">+</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">,</span> Origin<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">C_list <span class="operator">=</span> lapply<span class="punctuation">(</span>T_all<span class="punctuation">,</span>  <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">(</span>x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">+</span> x<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">+</span> x<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">C <span class="operator">=</span> do.call<span class="punctuation">(</span>rbind<span class="punctuation">,</span> C_list<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">A <span class="operator">=</span> vapply<span class="punctuation">(</span>T_all<span class="punctuation">,</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="built_in">abs</span><span class="punctuation">(</span>x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="punctuation">(</span>x<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> x<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">        x<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="punctuation">(</span>x<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">        x<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="punctuation">(</span>x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> x<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="punctuation">)</span> <span class="operator">/</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span> FUN.VALUE <span class="operator">=</span> double<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://scy11.oss-cn-beijing.aliyuncs.com/img/202309051055873.png">
Illustration of iterative centroid algorithm with triangles. The X
represents the area-weighted centroid in iterations 2 and 3.</p>
<p>现在，我们有条件完成第4步，使用<code>sum(A)</code>来计算总面积，以及使用
<code>weighted.mean(C[, 1], A)</code> 和
<code>weighted.mean(C[, 2], A)</code>
来计算多边形的质心坐标（给警觉的读者一个练习：验证这些命令是否有效）。为了展示算法与脚本之间的联系，本节的内容已经被压缩成
<code>11-centroid-alg.R</code>。我们在<em>脚本</em>节末尾看到，这个脚本如何计算一个正方形的质心。<em>编写脚本</em>
的优点是，它适用于新的 <code>poly_mat</code> 对象（参见下面的练习，以
<code>st_centroid()</code> 为参考来验证这些结果）：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source<span class="punctuation">(</span><span class="string">&quot;code/11-centroid-alg.R&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; [1] &quot;The area is: 245&quot;</span></span><br><span class="line"><span class="comment">#&gt; [1] &quot;The coordinates of the centroid are: 8.83, 9.22&quot;</span></span><br></pre></td></tr></table></figure>
<p>上面的示例表明，使用基础 R
从基础原理出发，<em>确实可以</em>开发出低级地理操作。它还表明，如果已经存在一个经过验证的解决方案，那么重新发明轮子可能是不值得的：如果我们的目标仅仅是找到多边形的质心，那么将<code>poly_mat</code>表示为一个<strong>sf</strong>对象并使用现有的<code>sf::st_centroid()</code>
函数可能会更快。然而，从1<sup>st</sup>
原理编写算法的巨大好处是，你将理解整个过程的每一个步骤，这是使用其他人代码时无法保证的。另一个需要考虑的因素是性能，与低级语言如C++相比，R在进行数字计算方面可能较慢（参见<em>地理计算软件</em>节），并且难以优化。如果目的是开发新方法，那么计算效率不应该是优先考虑的。这一点体现在“过早优化是编程中一切（或至少大部分）邪恶的根源”<span class="citation" data-cites="knuth_computer_1974">[@knuth_computer_1974]</span>这一说法中。</p>
<p>算法开发是困难的。这一点应该从开发一个仅仅是一种相对低效的解决方案、对实际问题（实际中凸多边形并不常见）具有有限应用的基础
R 的质心算法中显而易见。这种经验应该会让人更加重视像GEO（它是
<code>sf::st_centroid()</code>
的基础）和CGAL（计算几何算法库）这样的低级地理库，这些库不仅运行快，还适用于多种类型的输入几何。
这些库开源的一个重要优点是，其源代码便于学习、理解，并且（对于具备技能和信心的人）进行修改。<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<h1 id="函数">函数</h1>
<p>与算法类似，函数接收一个输入并返回一个输出。然而，函数是特定编程语言中实现的，而不是“配方”本身。在
R
中，函数本身就是对象，可以以模块化的方式创建和组合。例如，我们可以创建一个执行我们质心生成算法第二步的函数，如下所示：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t_centroid <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="punctuation">(</span>x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">+</span> x<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">+</span> x<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="number">3</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>上面的示例演示了<a target="_blank" rel="external nofollow noopener noreferrer" href="https://adv-r.hadley.nz/functions.html">函数</a>的两个关键组件：1）函数
<em>主体</em>，即定义函数如何处理输入的大括号内的代码；和 2）
<em>形式参数</em>，即函数使用的参数列表——在这种情况下是
<code>x</code>（第三个关键组件，环境，超出了本节的范围）。默认情况下，函数返回最后一个被计算的对象（在
<code>t_centroid()</code> 的情况下是质心的坐标）。<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>该函数现在适用于你传递给它的任何输入，如下面的命令所示，该命令计算了上一节中示例多边形中第1个三角形的面积：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t_centroid<span class="punctuation">(</span>T1<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; x_coords y_coords </span></span><br><span class="line"><span class="comment">#&gt;     14.0     11.7</span></span><br></pre></td></tr></table></figure>
<p>我们还可以创建一个函数来计算三角形的面积，我们将其命名为
<code>t_area()</code>：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">t_area <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="built_in">abs</span><span class="punctuation">(</span></span><br><span class="line">    x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="punctuation">(</span>x<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> x<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    x<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="punctuation">(</span>x<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    x<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="punctuation">(</span>x<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> x<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">/</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>注意，在创建函数之后，可以用一行代码计算三角形的面积，避免了冗长代码的重复：函数是一种
<em>泛化</em>
代码的机制。新创建的函数<code>t_area()</code>接受任何对象<code>x</code>，假设其具有与我们一直在使用的“三角形矩阵”数据结构相同的维度，并返回其面积，如下面在<code>T1</code>上的示例：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">t_area<span class="punctuation">(</span>T1<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; [1] 85</span></span><br></pre></td></tr></table></figure>
<p>我们可以通过使用它来找到一个新的三角形矩阵的面积来测试函数的泛化性，该三角形矩阵的高度为1，底边为3：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t_new <span class="operator">=</span> cbind<span class="punctuation">(</span>x <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">              y <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">t_area<span class="punctuation">(</span>t_new<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt;   x </span></span><br><span class="line"><span class="comment">#&gt; 1.5</span></span><br></pre></td></tr></table></figure>
<p>函数的一个有用特性是它们是模块化的。只要你知道输出会是什么，一个函数就可以用作另一个函数的构建块。因此，<code>t_centroid()</code>
和
<code>t_area()</code>可以用作更大的函数的子组件，以执行脚本<code>11-centroid-alg.R</code>的工作：计算任何凸多边形的面积。下面的代码块创建了
<code>poly_centroid()</code> 函数，以模仿针对凸多边形的
<code>sf::st_centroid()</code> 的行为：<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">poly_centroid <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>poly_mat<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  Origin <span class="operator">=</span> poly_mat<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="punctuation">]</span> <span class="comment"># create a point representing the origin</span></span><br><span class="line">  i <span class="operator">=</span> <span class="number">2</span><span class="operator">:</span><span class="punctuation">(</span>nrow<span class="punctuation">(</span>poly_mat<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line">  T_all <span class="operator">=</span> lapply<span class="punctuation">(</span>i<span class="punctuation">,</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span>rbind<span class="punctuation">(</span>Origin<span class="punctuation">,</span> poly_mat<span class="punctuation">[</span>x<span class="operator">:</span><span class="punctuation">(</span>x <span class="operator">+</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">,</span> Origin<span class="punctuation">)</span><span class="punctuation">&#125;</span><span class="punctuation">)</span></span><br><span class="line">  C_list <span class="operator">=</span> lapply<span class="punctuation">(</span>T_all<span class="punctuation">,</span> t_centroid<span class="punctuation">)</span></span><br><span class="line">  C <span class="operator">=</span> do.call<span class="punctuation">(</span>rbind<span class="punctuation">,</span> C_list<span class="punctuation">)</span></span><br><span class="line">  A <span class="operator">=</span> vapply<span class="punctuation">(</span>T_all<span class="punctuation">,</span> t_area<span class="punctuation">,</span> FUN.VALUE <span class="operator">=</span> double<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">c</span><span class="punctuation">(</span>weighted.mean<span class="punctuation">(</span>C<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span> A<span class="punctuation">)</span><span class="punctuation">,</span> weighted.mean<span class="punctuation">(</span>C<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">]</span><span class="punctuation">,</span> A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">poly_centroid<span class="punctuation">(</span>poly_mat<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; [1] 8.83 9.22</span></span><br></pre></td></tr></table></figure>
<p>像 <code>poly_centroid()</code>
这样的函数可以进一步扩展以提供不同类型的输出。例如，要将结果作为类
<code>sfg</code> 的对象返回，可以使用 '包装器' 函数来修改
<code>poly_centroid()</code> 的输出，然后返回结果：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">poly_centroid_sfg <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  centroid_coords <span class="operator">=</span> poly_centroid<span class="punctuation">(</span>x<span class="punctuation">)</span></span><br><span class="line">  sf<span class="operator">::</span>st_point<span class="punctuation">(</span>centroid_coords<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>我们可以通过以下方式验证输出与 <code>sf::st_centroid()</code>
的输出相同：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">poly_sfc <span class="operator">=</span> sf<span class="operator">::</span>st_polygon<span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span>poly_mat<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>poly_centroid_sfg<span class="punctuation">(</span>poly_mat<span class="punctuation">)</span><span class="punctuation">,</span> sf<span class="operator">::</span>st_centroid<span class="punctuation">(</span>poly_sfc<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; [1] FALSE</span></span><br></pre></td></tr></table></figure>
<h1 id="编程">编程</h1>
<p>在本章中，我们的速度很快，从脚本到函数，再到算法这个棘手的主题。我们不仅在抽象层面上讨论了它们，还创建了针对特定问题的工作示例：</p>
<ul>
<li>介绍并演示了在'多边形矩阵'上运行的脚本<code>11-centroid-alg.R</code></li>
<li>描述了允许此脚本工作的各个步骤，被称为算法，一个计算性的配方</li>
<li>为了通用化这个算法，我们将其转换成模块化的函数，最终组合成上一节中的函数<code>poly_centroid()</code></li>
</ul>
<p>每一个可能看似简单。然而，熟练的编程是复杂的，涉及将每个元素——脚本、算法和函数——<em>组合</em>成一个<em>系统</em>，具有效率和风格。最终的结果应该是健壮且用户友好的工具，供其他人使用。如我们预期本书的大多数读者将是编程新手，能够遵循并复现前面几节的结果是一个重大成就。编程需要许多小时的专门学习和实践才能熟练。</p>
<p>面对希望以有效方式实现新算法的开发者的挑战，可以通过考虑创建一个简单但并非用于生产的函数所付出的努力量来考虑：在当前状态下，<code>poly_centroid()</code>在大多数（非凸）多边形上失败！这提出了一个问题：如何通用化这个函数？两个选项是（1）找到三角化非凸多边形的方法（这是本章支持的在线<a target="_blank" rel="external nofollow noopener noreferrer" href="https://geocompx.github.io/geocompkg/articles/algorithm.html">算法</a>文章所涵盖的主题）和（2）探索其他不依赖于三角网格的质心算法。</p>
<p>一个更广泛的问题是：当已经有高性能的算法被实现并打包成诸如<code>st_centroid()</code>这样的函数时，是否值得编程解决方案？在这个特定情况下，简单的答案是'否'。在更广泛的背景下，考虑到学习编程的好处，答案是'视情况而定'。在编程中，很容易浪费时间尝试实现一种方法，只有到最后才发现有人已经做了艰苦的工作。你可以把这一章看作是通往几何算法编程魔法的垫脚石。然而，它也可以被看作是何时尝试编程一个通用解决方案，以及何时使用现有的更高级解决方案的一堂课。肯定会有编写新函数是最佳方案的时候，但也会有使用已经存在的函数是最佳方案的时候。</p>
<p>“不要重复发明轮子”一样适用于编程，甚至更适用于生活中的其他方面。项目开始时进行一点研究和思考可以帮助决定编程时间最好如何使用。以下三个原则也可以帮助最大化编写代码时的努力，无论它是一个简单的脚本还是由数百个函数组成的包：</p>
<ol type="1">
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a>（不要重复自己）：尽量减少代码重复，并以更少的代码行解决特定问题。
这一原则在《R for Data Science》<span class="citation" data-cites="grolemund_r_2016">[@grolemund_r_2016]</span>的函数章节中有解释。</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/KISS_principle">KISS</a>（保持简单愚蠢）：这一原则建议首先尝试简单解决方案，优先于复杂解决方案，需要时使用依赖项，目标是保持脚本简洁。
这一原则是<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.nature.com/articles/d41586-018-05004-4">名言</a>“事物应尽量简单，但不能更简单”的计算类比。</li>
<li>模块性：如果你的代码被划分成明确定义的片段，它将更容易维护。一个函数应该只做一件事，但要做得非常好。如果你的函数变得太长，考虑将其拆分成多个小函数，每个都可以用于其他目的，支持DRY和KISS原则。</li>
</ol>
<p>我们不能保证这一章会立即让你能够为你的工作创建完美的函数。然而，我们确信其内容将帮助你决定何时是适当的尝试时机（当没有其他现有的函数解决问题，当编程任务在你的能力范围内，当解决方案的好处可能大于开发它的时间成本）。通过使用上述原则，结合通过完成上面的实例获得的实践经验，你将建立你的脚本编写、包编写和编程技能。编程的第一步可能会很慢（下面的练习不应该匆忙完成），但长期的回报可能会很大。</p>
<h1 id="练习">练习</h1>
<p>E1. 阅读脚本 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/geocompx/geocompr/blob/main/code/11-centroid-alg.R"><code>11-centroid-alg.R</code></a>，它位于书籍GitHub仓库的
<code>code</code> 文件夹中。</p>
<ul>
<li>它遵循了在章节<a href="#脚本">1.3</a>中介绍的哪些最佳实践？</li>
<li>在你的电脑上通过一个IDE（比如
RStudio）创建这个脚本的一个版本（最好是通过逐行键入脚本，用你自己的编码风格和你自己的注释，而不是复制粘贴——这将帮助你学会如何键入脚本）。以一个方形多边形为例（例如，通过
<code>poly_mat = cbind(x = c(0, 9, 9, 0, 0), y = c(0, 0, 9, 9, 0))</code>
创建），逐行执行脚本。</li>
<li>可以对脚本进行哪些更改以使其更具可重复性？</li>
<li>如何改进文档？</li>
</ul>
<p>E2. 在几何算法部分，我们计算了由 <code>poly_mat</code>
表示的多边形的面积和地理质心分别为245和8.8, 9.2。</p>
<ul>
<li>参考脚本 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/geocompx/geocompr/blob/main/code/11-centroid-alg.R"><code>11-centroid-alg.R</code></a>
在你自己的电脑上重现结果（奖励：键入命令 - 尽量避免复制粘贴）。</li>
<li>结果正确吗？通过将 <code>poly_mat</code> 转换为名为
<code>poly_sfc</code> 的 <code>sfc</code> 对象（使用
<code>st_polygon()</code>（提示：此函数接受 <code>list()</code>
类对象）），然后使用 <code>st_area()</code> 和
<code>st_centroid()</code> 来验证结果。</li>
</ul>
<p>E3.
之前提到我们创建的算法只适用于<em>凸包</em>。定义凸包（见几何运算章节），并测试该算法在一个<em>非</em>凸包的多边形上的效果。</p>
<ul>
<li>奖励1：思考为什么该方法仅适用于凸包，并注意要对算法做哪些更改才能使其适用于其他类型的多边形。</li>
<li>奖励2：基于 <code>11-centroid-alg.R</code>
的内容，仅使用基础R函数编写一个算法，找出以矩阵形式表示的线串的总长度。</li>
</ul>
<!-- Todo: 添加表示线串的矩阵的示例，演示代码以验证答案，建议解构为奖励的其他函数。 -->
<p>E4. 在函数部分，我们创建了不同版本的 <code>poly_centroid()</code>
函数，它们生成了 <code>sfg</code>
类的输出（<code>poly_centroid_sfg()</code>）和类型稳定的
<code>matrix</code> 输出（<code>poly_centroid_type_stable()</code>）。
进一步扩展该函数，创建一个版本（例如，名为
<code>poly_centroid_sf()</code>），该版本是类型稳定的（仅接受
<code>sf</code> 类的输入）<em>并且</em>返回 <code>sf</code>
对象（提示：你可能需要用命令 <code>sf::st_coordinates(x)</code> 将对象
<code>x</code> 转换为矩阵）。</p>
<ul>
<li>通过运行
<code>poly_centroid_sf(sf::st_sf(sf::st_sfc(poly_sfc)))</code>
来验证它的工作原理</li>
<li>当你尝试运行 <code>poly_centroid_sf(poly_mat)</code>
时，你得到什么错误信息？</li>
</ul>
<aside id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>
之前的步骤可以用注释或者if语句来指出，比如<code>if (!exists("x")) source("x.R")</code>（如果对象<code>x</code>不存在，则会运行脚本文件<code>x.R</code>）。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>可以用以下公式（该公式假设底边是水平的）来验证结果：面积是底边宽度与高度乘积的一半，<span class="math inline">\(A = B * H / 2\)</span>。在这种情况下 <span class="math inline">\(10 * 10 / 2 = 50\)</span>。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>有关文档，请参见
<code>?lapply</code>，更多关于迭代的信息，请参见第@ref(location)章。<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>事实上，CGAL函数 <code>CGAL::centroid()</code>
是由7个子函数组成的，如https://doc.cgal.org/latest/Kernel_23/group__centroid__grp.html
所描述，使其能够适用于多种类型的输入数据，而我们创建的解决方案仅适用于一种非常特定的输入数据类型。GEOS
函数 <code>Centroid::getCentroid()</code> 的底层源代码可以在
https://github.com/libgeos/geos/search?q=getCentroid 上找到。<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>你也可以通过在函数主体中添加 <code>return(output)</code>
明确设置函数的输出，其中 <code>output</code> 是要返回的结果。<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>注意，我们创建的函数在 <code>lapply()</code>和
<code>vapply()</code> 函数调用中被迭代地调用。<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</aside>

            
        </div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/19/2023-8-19-10%E8%BF%9E%E6%8E%A5%E5%88%B0GIS%E8%BD%AF%E4%BB%B6%E7%9A%84%E6%A1%A5%E6%A2%81/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/19/2023-8-19-10%E8%BF%9E%E6%8E%A5%E5%88%B0GIS%E8%BD%AF%E4%BB%B6%E7%9A%84%E6%A1%A5%E6%A2%81/" class="post-title-link" itemprop="url">(10)连接到GIS的桥梁</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-19 19:55:20" itemprop="dateCreated datePublished" datetime="2023-08-19T19:55:20+08:00">2023-08-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-04 12:11:39" itemprop="dateModified" datetime="2023-10-04T12:11:39+08:00">2023-10-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/19/2023-8-19-10%E8%BF%9E%E6%8E%A5%E5%88%B0GIS%E8%BD%AF%E4%BB%B6%E7%9A%84%E6%A1%A5%E6%A2%81/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/19/2023-8-19-10%E8%BF%9E%E6%8E%A5%E5%88%B0GIS%E8%BD%AF%E4%BB%B6%E7%9A%84%E6%A1%A5%E6%A2%81/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>49 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/gis">第十章</a></p>
</blockquote>
<p>R
等具有交互式控制台的语言的一个特点——严格来说是一个读取-求值-打印循环（REPL）——
是你与它们互动的方式。与其依赖于在屏幕的不同部分上指点和点击，你可以将命令键入控制台，并使用
<code>Enter</code> 键执行它们。使用像RStudio或VS
Code这样的交互式开发环境时，一个常见且有效的工作流程是将代码键入源文件的源编辑器中，并使用像<code>Ctrl+Enter</code>这样的快捷方式来控制代码的交互式执行。
            <!--noindex-->
            <div class="post-button">
                <a class="btn" href="/2023/08/19/2023-8-19-10%E8%BF%9E%E6%8E%A5%E5%88%B0GIS%E8%BD%AF%E4%BB%B6%E7%9A%84%E6%A1%A5%E6%A2%81/#more" rel="contents">
                    阅读全文 &raquo;
                </a>
            </div>
            <!--/noindex-->
            
            
        </p></div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/18/2023-8-18-9%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E5%88%B6%E5%9B%BE/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/18/2023-8-18-9%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E5%88%B6%E5%9B%BE/" class="post-title-link" itemprop="url">(9)地理数据制图</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-18 06:35:20" itemprop="dateCreated datePublished" datetime="2023-08-18T06:35:20+08:00">2023-08-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-03 01:46:52" itemprop="dateModified" datetime="2023-10-03T01:46:52+08:00">2023-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/18/2023-8-18-9%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E5%88%B6%E5%9B%BE/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/18/2023-8-18-9%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E5%88%B6%E5%9B%BE/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>45 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/adv-map">第九章</a></p>
</blockquote>
<h1 id="前提条件">前提条件</h1>
<ul>
<li>本章需要使用我们已经在使用的以下包：</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>sf<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>terra<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>spData<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>spDataLarge<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>此外，本章还使用以下可视化包（如果您想开发交互式地图应用程序，请安装shiny）：</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># remotes::install_github(&quot;r-tmap/tmap@v4&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>tmap<span class="punctuation">)</span>    <span class="comment"># for static and interactive maps</span></span><br><span class="line">library<span class="punctuation">(</span>leaflet<span class="punctuation">)</span> <span class="comment"># for interactive maps</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span> <span class="comment"># tidyverse data visualization package</span></span><br></pre></td></tr></table></figure>
<ul>
<li>您还需要按照以下方式读取几个数据集，以进行<em>栅格数据的空间操作</em>部分的内容：</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nz_elev <span class="operator">=</span> rast<span class="punctuation">(</span>system.file<span class="punctuation">(</span><span class="string">&quot;raster/nz_elev.tif&quot;</span><span class="punctuation">,</span> package <span class="operator">=</span> <span class="string">&quot;spDataLarge&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h1 id="引言">引言</h1>
<p>地理研究中令人满意和重要的一个方面是传达研究结果。制图——地图制作的艺术——是一项古老的技能，涉及沟通、细节关注和创造性元素。在R中进行静态制图非常简单，可以使用<code>plot()</code>函数。通过使用基本R方法，可以创建高级地图。然而，本章的重点是使用专门的制图包进行地图制作。在学习新技能时，首先在一个领域深入掌握知识，然后再进行扩展，这是合乎情理的做法。制图也不例外，因此本章深入介绍了一个包（<strong>tmap</strong>），而不是浅尝辄止地介绍多个包。</p>
<p>除了有趣和富有创意外，制图还具有重要的实际应用。精心制作的地图可能是传达工作结果的最佳方式，但设计不良的地图可能会留下不好的印象。常见的设计问题包括文本的位置、大小和可读性差，以及颜色的选择不慎，正如《地图杂志》的风格<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.tandf.co.uk//journals/authors/style/TJOM-suppmaterial-quick-guide.pdf">指南</a>中所述。此外，糟糕的地图制作可能会妨碍结果的传达：</p>
<blockquote>
<p>看起来业余的地图可能会削弱您的受众理解重要信息的能力，减弱专业数据调查的呈现效果。
数千年来，地图已被用于各种各样的目的。
历史上的例子包括3000多年前的旧巴比伦王朝的建筑和土地所有权地图，以及近2000年前托勒密在他的杰作<em>地理学</em>中的世界地图。</p>
</blockquote>
<p>制图活动在历史上曾经只由精英或代表精英进行。随着开源地图制作软件的出现，如R包<strong>tmap</strong>和QGIS中的'print
composer'，任何人都可以制作高质量的地图，从而实现了'公民科学'。地图也常常是以易于理解的方式呈现地理计算研究结果的最佳途径。制图因此是地理计算的关键部分，它不仅强调描述世界，还强调<em>改变</em>世界。</p>
<p>本章介绍了如何制作各种类型的地图。接下来的部分将涵盖静态地图的各种情况，包括美学考虑、分面和插图地图。部分章节将介绍动态和交互式地图（包括网络地图和地图应用程序）。最
后，将介绍一系列备选的地图制作包，包括<strong>ggplot2</strong>和<strong>cartogram</strong>。</p>
<h1 id="静态地图">静态地图</h1>
<p>静态地图是地理计算的最常见的可视输出类型。它们通常以标准格式保存，包括
<code>.png</code>和<code>.pdf</code>用于图形光栅和矢量输出。最初，静态地图是R唯一能够生成的地图类型。随着<strong>sp</strong>的发布[<a href="mailto:见@pebesma" class="email" rel="external nofollow noopener noreferrer" target="_blank">见@pebesma</a>_classes_2005]，自那时以来，许多地图制作技术、函数和软件包得到了发展。然而，尽管有交互式地图的创新，静态绘图仍然是十年后R中地理数据可视化的重点。</p>
<p>通用的 <code>plot()</code>
函数是从矢量和栅格空间对象创建静态地图的最快方法。有时，在项目开发阶段，简单性和速度是首要考虑的因素，这就是
<code>plot()</code> 函数的优势所在。 基本的 R
方法也是可扩展的，<code>plot()</code>
函数提供了许多参数选项。另一种方法是使用 <strong>grid</strong>
软件包，它允许对静态地图进行低级别的控制，如 <span class="citation" data-cites="murrell_r_2016">@murrell_r_2016</span> 的第 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.stat.auckland.ac.nz/~paul/RG2e/chapter14.html">14</a>
章所示。本书的这部分将重点介绍
<strong>tmap</strong>，并强调其基本的美学和布局选项。</p>
<p><strong>tmap</strong>是一个功能强大且灵活的制图软件包，具有合理的默认设置。它具有简洁的语法，允许使用最少的代码创建具有吸引力的地图，这对于
<strong>ggplot2</strong>
用户来说会非常熟悉。它还具有独特的功能，通过<code>tmap_mode()</code>可以生成静态和交互式地图，使用相同的代码。最后，它接受比其他替代方案（如
<strong>ggplot2</strong>）更广泛的空间类别（包括 <strong>sf</strong> 和
<strong>terra</strong> 对象）。 <!--toDo:jn-->
<!-- update the below vignettes links -->
<!-- (see the vignettes [`tmap-getstarted`](https://cran.r-project.org/web/packages/tmap/vignettes/tmap-getstarted.html) and [`tmap-changes-v2`](https://cran.r-project.org/web/packages/tmap/vignettes/tmap-changes-v2.html), as well as @tennekes_tmap_2018, for further documentation). --></p>
<h2 id="tmap-基础">tmap 基础</h2>
<p>与<strong>ggplot2</strong>类似，<strong>tmap</strong>基于"图形语法"的理念。这涉及将输入数据与美学（数据如何可视化）分离：每个输入数据集可以通过多种不同的方式进行"映射"，包括在地图上的位置（由数据的<code>geometry</code>定义）、颜色和其他视觉变量。基本构建块是
<code>tm_shape()</code>（定义输入数据：矢量或栅格对象），然后是一个或多个图层元素，如
<code>tm_fill()</code> 和
<code>tm_dots()</code>。以下代码块演示了这种分层结构，生成了图中呈现的地图：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add fill layer to nz shape</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_fill<span class="punctuation">(</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment"># Add border layer to nz shape</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_borders<span class="punctuation">(</span><span class="punctuation">)</span> </span><br><span class="line"><span class="comment"># Add fill and border layers to nz shape</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_fill<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_borders<span class="punctuation">(</span><span class="punctuation">)</span> </span><br></pre></td></tr></table></figure>
<p><img data-src="https://scy11.oss-cn-beijing.aliyuncs.com/img/202309031738903.png">
New Zealand's shape plotted with fill (left), border (middle) and fill
and border (right) layers added using tmap functions.</p>
<p>在这种情况下，传递给<code>tm_shape()</code>的对象是<code>nz</code>，一个代表新西兰各个地区的<code>sf</code>对象。添加图层以在视觉上表示<code>nz</code>，使用<code>tm_fill()</code>和<code>tm_borders()</code>分别在上图的左侧面板和中间面板中创建了阴影区。</p>
<ul>
<li><code>tm_fill()</code>: （多）多边形的阴影区域</li>
<li><code>tm_borders()</code>: （多）多边形的边界轮廓</li>
<li><code>tm_polygons()</code>: （多）多边形的阴影区域和边界轮廓</li>
<li><code>tm_lines()</code>: （多）线串的线条</li>
<li><code>tm_symbols()</code>: （多）点、线串和多边形的符号</li>
<li><code>tm_raster()</code>:
栅格数据的彩色单元格（也有用于具有三个图层的栅格的
<code>tm_rgb()</code>）</li>
<li><code>tm_text()</code>: （多）点、线串和多边形的文本信息</li>
</ul>
<!--toDo: jn-->
<!-- update help link -->
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 请参阅 `help(&quot;tmap-element&quot;)` 获取所有可能的图层类型的完整列表。这种图层叠加效果在图的右侧面板中得以体现，这是在填充图层之上添加了边界。 --&gt;</span><br></pre></td></tr></table></figure>
<!--toDo: jn-->
<!-- update when/if -->
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">&gt; `qtm()` 是一个方便的函数，用于创建快速、主题、地图（因此取了一个简洁的名字）。</span><br><span class="line">它非常简洁，对许多情况下都提供了很好的默认可视化效果：例如，`qtm(nz)` 等同于 `tm_shape(nz) + tm_fill() + tm_borders()`。</span><br><span class="line">此外，可以使用多个 `qtm()` 调用简洁地添加图层，例如 `qtm(nz) + qtm(nz_height)`。</span><br><span class="line">缺点是它使得单个图层的美学更难以控制，这就解释了为什么我们在本章中避免教授它。</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>
<h2 id="地图对象">地图对象</h2>
<p><strong>tmap</strong>
的一个有用特性是它能够存储代表地图的<em>对象</em>。下面的代码块演示了这一点，通过将上图中的最后一个绘图保存为一个<code>tmap</code>类型的对象（注意使用了<code>tm_polygons()</code>，它将<code>tm_fill()+tm_borders()</code>结合成一个函数）：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">map_nz <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>map_nz<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; [1] &quot;tmap&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>map_nz</code>可以进行绘图，例如添加额外的图层（如下所示），或者只需在控制台中运行
<code>map_nz</code>，这相当于 <code>print(map_nz)</code>。</p>
<p>可以使用 <code>+ tm_shape(new_obj)</code>
添加新的<em>shapes</em>。在这种情况下，<code>new_obj</code>表示要绘制在之前图层之上的新的空间对象。当以这种方式添加新的形状shape时，所有后续的美学函数都会与它相关联，直到添加另一个新的shape为止。这种语法允许创建具有多个形状和图层的地图，如下面的代码块所示，使用函数
<code>tm_raster()</code>绘制一个栅格图层（设置<code>col_alpha</code>
使图层半透明）：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map_nz1 <span class="operator">=</span> map_nz <span class="operator">+</span></span><br><span class="line">  tm_shape<span class="punctuation">(</span>nz_elev<span class="punctuation">)</span> <span class="operator">+</span> tm_raster<span class="punctuation">(</span>col_alpha <span class="operator">=</span> <span class="number">0.7</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<!--toDo: jn-->
<!-- explain the SpatRaster object downsampled to 1141 by 877 cells. message -->
<p>Building on the previously created <code>map_nz</code> object, the
preceding code creates a new map object <code>map_nz1</code> that
contains another shape (<code>nz_elev</code>) representing average
elevation across New Zealand (see Figure @ref(fig:tmlayers), left). More
shapes and layers can be added, as illustrated in the code chunk below
which creates <code>nz_water</code>, representing New Zealand's <a target="_blank" rel="external nofollow noopener noreferrer" href="https://en.wikipedia.org/wiki/Territorial_waters">territorial
waters</a>, and adds the resulting lines to an existing map object.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nz_water <span class="operator">=</span> st_union<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  st_buffer<span class="punctuation">(</span><span class="number">22200</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  st_cast<span class="punctuation">(</span>to <span class="operator">=</span> <span class="string">&quot;LINESTRING&quot;</span><span class="punctuation">)</span></span><br><span class="line">map_nz2 <span class="operator">=</span> map_nz1 <span class="operator">+</span></span><br><span class="line">  tm_shape<span class="punctuation">(</span>nz_water<span class="punctuation">)</span> <span class="operator">+</span> tm_lines<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>There is no limit to the number of layers or shapes that can be added
to <code>tmap</code> objects, and the same shape can even be used
multiple times. The final map illustrated in Figure @ref(fig:tmlayers)
is created by adding a layer representing high points (stored in the
object <code>nz_height</code>) onto the previously created
<code>map_nz2</code> object with <code>tm_symbols()</code> (see
<code>?tm_symbols</code> for details on <strong>tmap</strong>'s point
plotting functions). The resulting map, which has four layers, is
illustrated in the right-hand panel of Figure @ref(fig:tmlayers):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map_nz3 <span class="operator">=</span> map_nz2 <span class="operator">+</span></span><br><span class="line">  tm_shape<span class="punctuation">(</span>nz_height<span class="punctuation">)</span> <span class="operator">+</span> tm_symbols<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>A useful and little known feature of <strong>tmap</strong> is that
multiple map objects can be arranged in a single 'metaplot' with
<code>tmap_arrange()</code>. This is demonstrated in the code chunk
below which plots <code>map_nz1</code> to <code>map_nz3</code>,
resulting in Figure @ref(fig:tmlayers).</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tmap_arrange<span class="punctuation">(</span>map_nz1<span class="punctuation">,</span> map_nz2<span class="punctuation">,</span> map_nz3<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/tmlayers-1.png" alt="Maps with additional layers added to the final map of Figure 9.1." width="100%">
<p class="caption">
(#fig:tmlayers)Maps with additional layers added to the final map of
Figure 9.1.
</p>
</div>
<p>More elements can also be added with the <code>+</code> operator.
Aesthetic settings, however, are controlled by arguments to layer
functions.</p>
<h2 id="可视化变量">可视化变量</h2>
<p>The plots in the previous section demonstrate <strong>tmap</strong>'s
default aesthetic settings. Gray shades are used for
<code>tm_fill()</code> and <code>tm_symbols()</code> layers and a
continuous black line is used to represent lines created with
<code>tm_lines()</code>. Of course, these default values and other
aesthetics can be overridden. The purpose of this section is to show
how.</p>
<p>There are two main types of map aesthetics: those that change with
the data and those that are constant. Unlike <strong>ggplot2</strong>,
which uses the helper function <code>aes()</code> to represent variable
aesthetics, <strong>tmap</strong> accepts a few aesthetic arguments,
depending on a selected layer type:</p>
<ul>
<li><code>fill</code>: fill color of a polygon</li>
<li><code>col</code>: color of a polygon border, line, point, or
raster</li>
<li><code>lwd</code>: line width</li>
<li><code>lty</code>: line type</li>
<li><code>size</code>: size of a symbol</li>
<li><code>shape</code>: shape of a symbol</li>
</ul>
<p>Additionally, we may customize the fill and border color transparency
using <code>fill_alpha</code> and <code>col_alpha</code>.</p>
<p>To map a variable to an aesthetic, pass its column name to the
corresponding argument, and to set a fixed aesthetic, pass the desired
value instead.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> The impact of setting these with
fixed values is illustrated in Figure @ref(fig:tmstatic).</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ma1 <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span></span><br><span class="line">ma2 <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> fill_alpha <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">)</span></span><br><span class="line">ma3 <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>col <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">)</span></span><br><span class="line">ma4 <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>lwd <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">ma5 <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>lty <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line">ma6 <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> fill_alpha <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span></span><br><span class="line">                                 col <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> lwd <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> lty <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line">tmap_arrange<span class="punctuation">(</span>ma1<span class="punctuation">,</span> ma2<span class="punctuation">,</span> ma3<span class="punctuation">,</span> ma4<span class="punctuation">,</span> ma5<span class="punctuation">,</span> ma6<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/tmstatic-1.png" alt="The impact of changing commonly used fill and border aesthetics to fixed values." width="100%">
<p class="caption">
(#fig:tmstatic)The impact of changing commonly used fill and border
aesthetics to fixed values.
</p>
</div>
<p>Like base R plots, arguments defining aesthetics can also receive
values that vary. Unlike the base R code below (which generates the left
panel in Figure @ref(fig:tmcol)), <strong>tmap</strong> aesthetic
arguments will not accept a numeric vector:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plot<span class="punctuation">(</span>st_geometry<span class="punctuation">(</span>nz<span class="punctuation">)</span><span class="punctuation">,</span> col <span class="operator">=</span> nz<span class="operator">$</span>Land_area<span class="punctuation">)</span>  <span class="comment"># works</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_fill<span class="punctuation">(</span>col <span class="operator">=</span> nz<span class="operator">$</span>Land_area<span class="punctuation">)</span> <span class="comment"># fails</span></span><br><span class="line"><span class="comment">#&gt; Error: palette should be a character value</span></span><br></pre></td></tr></table></figure>
<p>Instead <code>col</code> (and other aesthetics that can vary such as
<code>lwd</code> for line layers and <code>size</code> for point layers)
requires a character string naming an attribute associated with the
geometry to be plotted. Thus, one would achieve the desired result as
follows (plotted in the right-hand panel of Figure @ref(fig:tmcol)):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_fill<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;Land_area&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/tmcol-1.png" alt="Comparison of base (left) and tmap (right) handling of a numeric color field." width="45%"><img data-src="09-mapping_files/figure-html/tmcol-2.png" alt="Comparison of base (left) and tmap (right) handling of a numeric color field." width="45%">
<p class="caption">
(#fig:tmcol)Comparison of base (left) and tmap (right) handling of a
numeric color field.
</p>
</div>
<p>Each visual variable has three related additional arguments, with
prefixes of <code>.scale</code>, <code>.legend</code>, and
<code>.free</code>. For example, the <code>tm_fill()</code> function has
arguments such as <code>fill</code>, <code>fill.scale</code>,
<code>fill.legend</code>, and <code>fill.free</code>. The
<code>.scale</code> argument determines how the provided values are
represented on the map and in the legend (Section @ref(scales)), while
the <code>.legend</code> argument is used to customize the legend
settings, such as its title, orientation, or position (Section
@ref(legends)). The <code>.free</code> argument is relevant only for
maps with many facets to determine if each facet has the same or
different scale and legend (Section @ref(faceted-maps)).</p>
<h2 id="标度">标度</h2>
<p> Scales control how the values are represented on the map and in the
legend, and largely depend on the selected visual variable. For example,
when our visual variable is <code>col</code>, then
<code>col.scale</code> controls how the colors of spatial objects are
related to the provided values; and when our visual variable is
<code>size</code>, then <code>size.scale</code> controls how the sizes
represent the provided values. By default, the used scale is
<code>tm_scale()</code>, which selects the visual settings automatically
given by the data type (factor, numeric, and integer).</p>
<p> Let's see how the scales work by customizing polygons' fill colors.
Color settings are an important part of map design -- they can have a
major impact on how spatial variability is portrayed as illustrated in
Figure @ref(fig:tmpal). This figure shows four ways of coloring regions
in New Zealand depending on median income, from left to right (and
demonstrated in the code chunk below):</p>
<ul>
<li>The default setting uses 'pretty' breaks, described in the next
paragraph</li>
<li><code>breaks</code> allows you to manually set the breaks</li>
<li><code>n</code> sets the number of bins into which numeric variables
are categorized</li>
<li><code>values</code> defines the color scheme, for example,
<code>BuGn</code></li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;Median_income&quot;</span><span class="punctuation">)</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;Median_income&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           fill.scale <span class="operator">=</span> tm_scale<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">30000</span><span class="punctuation">,</span> <span class="number">40000</span><span class="punctuation">,</span> <span class="number">50000</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;Median_income&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           fill.scale <span class="operator">=</span> tm_scale<span class="punctuation">(</span>n <span class="operator">=</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;Median_income&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           fill.scale <span class="operator">=</span> tm_scale<span class="punctuation">(</span>values <span class="operator">=</span> <span class="string">&quot;BuGn&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/tmpal-1.png" alt="Illustration of settings that affect color settings. The results show (from left to right): default settings, manual breaks, n breaks, and the impact of changing the palette." width="100%">
<p class="caption">
(#fig:tmpal)Illustration of settings that affect color settings. The
results show (from left to right): default settings, manual breaks, n
breaks, and the impact of changing the palette.
</p>
</div>

<div class="rmdnote">
All of the above arguments (<code>breaks</code>, <code>n</code>, and
<code>values</code>) also work for other types of visual variables. For
example, <code>values</code> expects a vector of colors or a palette
name for <code>fill.scale</code> or <code>col.scale</code>, a vector of
sizes for <code>size.scale</code>, or a vector of symbols for
<code>shape.scale</code>.
</div>
<p> We are also able to customize scales using a family of functions
that start with the <code>tm_scale_</code> prefix. The most important
ones are <code>tm_scale_intervals()</code>,
<code>tm_scale_continuous()</code>, and
<code>tm_scale_categorical()</code>.</p>
<p> The <code>tm_scale_intervals()</code> function splits the input data
values into a set of intervals. In addition to manually setting
<code>breaks,</code> <strong>tmap</strong> allows users to specify
algorithms to create breaks with the <code>style</code> argument
automatically. Here are some of the most useful scale functions (Figure
@ref(fig:break-styles)):</p>
<ul>
<li><code>style = "pretty"</code>: the default setting, rounds breaks
into whole numbers where possible and spaces them evenly</li>
<li><code>style = "equal"</code>: divides input values into bins of
equal range and is appropriate for variables with a uniform distribution
(not recommended for variables with a skewed distribution as the
resulting map may end-up having little color diversity)</li>
<li><code>style = "quantile"</code>: ensures the same number of
observations fall into each category (with the potential downside that
bin ranges can vary widely)</li>
<li><code>style = "jenks"</code>: identifies groups of similar values in
the data and maximizes the differences between categories</li>
<li><code>style = "log10_pretty"</code>: a common logarithmic (the
logarithm to base 10) version of the regular pretty style used for
variables with a right-skewed distribution</li>
</ul>

<div class="rmdnote">
Although <code>style</code> is an argument of <strong>tmap</strong>
functions, in fact it originates as an argument in
<code>classInt::classIntervals()</code> --- see the help page of this
function for details.
</div>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/break-styles-1.png" alt="Illustration of different interval scales' methods set using the style argument in tmap." width="100%">
<p class="caption">
(#fig:break-styles)Illustration of different interval scales' methods
set using the style argument in tmap.
</p>
</div>
<p> The <code>tm_scale_continuous()</code> function present a large
number of colors over continuous color fields and are particularly
suited for continuous rasters. In case of variables with skewed
distribution you can also use its variants --
<code>tm_scale_continuous_log()</code> and
<code>tm_scale_continuous_log1p()</code>. Finally,
<code>tm_scale_categorical()</code> was designed to represent
categorical values and assures that each category receives a unique
color (Figure @ref(fig:concat)).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#&gt; Warning in strwidth(comp$text, units = &quot;inch&quot;, family = comp$fontfamily, : no</span><br><span class="line">#&gt; font could be found for family &quot;monospace&quot;</span><br><span class="line"></span><br><span class="line">#&gt; Warning in strwidth(comp$text, units = &quot;inch&quot;, family = comp$fontfamily, : no</span><br><span class="line">#&gt; font could be found for family &quot;monospace&quot;</span><br><span class="line">#&gt; Warning in strwidth(comp$text, units = &quot;inch&quot;, family = comp$fontfamily, : font</span><br><span class="line">#&gt; family &#x27;monospace&#x27; not found, will use &#x27;sans&#x27; instead</span><br><span class="line"></span><br><span class="line">#&gt; Warning in strwidth(comp$text, units = &quot;inch&quot;, family = comp$fontfamily, : font</span><br><span class="line">#&gt; family &#x27;monospace&#x27; not found, will use &#x27;sans&#x27; instead</span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/concat-1.png" alt="Illustration of continuous and categorical scales in tmap." width="100%">
<p class="caption">
(#fig:concat)Illustration of continuous and categorical scales in tmap.
</p>
</div>
<p> Palettes define the color ranges associated with the bins and
determined by the <code>tm_scale_*()</code> functions, and its
<code>breaks</code> and <code>n</code> arguments described above. The
default color palette is specified in <code>tm_layout()</code> (see
Section @ref(layouts) to learn more); however, it could be quickly
changed using the <code>values</code> argument. It expects a vector of
colors or a new color palette name, which can be find interactively with
<code>cols4all::c4a_gui()</code>. You can also add a <code>-</code> as
the color palette name prefix to reverse the palette order.</p>

<div class="rmdnote">
All of the default <code>values</code> of the visual variables, such as
default color palettes for different types of input variables, can be
found with <code>tmap_options()$values.var</code>.
</div>
<p>There are three main groups of color palettes: categorical,
sequential and diverging (Figure @ref(fig:colpal)), and each of them
serves a different purpose.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Categorical palettes
consist of easily distinguishable colors and are most appropriate for
categorical data without any particular order such as state names or
land cover classes. Colors should be intuitive: rivers should be blue,
for example, and pastures green. Avoid too many categories: maps with
large legends and many colors can be uninterpretable. <!--^[
toDo:jn
tmap4??
`fill = "MAP_COLORS"` can be used in maps with a large number of individual polygons (for example, a map of individual countries) to create unique fill colors for adjacent polygons.]
--></p>
<p>The second group is sequential palettes. These follow a gradient, for
example from light to dark colors (light colors often tend to represent
lower values), and are appropriate for continuous (numeric) variables.
Sequential palettes can be single (<code>greens</code> goes from light
to dark blue, for example) or multi-color/hue (<code>yl_gn_bu</code> is
gradient from light yellow to blue via green, for example), as
demonstrated in the code chunk below --- output not shown, run the code
yourself to see the results!</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span><span class="string">&quot;Median_income&quot;</span><span class="punctuation">,</span> fill.scale <span class="operator">=</span> tm_scale<span class="punctuation">(</span>values <span class="operator">=</span> <span class="string">&quot;greens&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span><span class="string">&quot;Median_income&quot;</span><span class="punctuation">,</span> fill.scale <span class="operator">=</span> tm_scale<span class="punctuation">(</span>values <span class="operator">=</span> <span class="string">&quot;yl_gn_bu&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>The third group, diverging palettes, typically range between three
distinct colors (purple-white-green in Figure @ref(fig:colpal)) and are
usually created by joining two single-color sequential palettes with the
darker colors at each end. Their main purpose is to visualize the
difference from an important reference point, e.g., a certain
temperature, the median household income or the mean probability for a
drought event. The reference point's value can be adjusted in
<strong>tmap</strong> using the <code>midpoint</code> argument.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  tm_polygons<span class="punctuation">(</span><span class="string">&quot;Median_income&quot;</span><span class="punctuation">,</span></span><br><span class="line">              fill.scale <span class="operator">=</span> tm_scale_continuous<span class="punctuation">(</span>values <span class="operator">=</span> <span class="string">&quot;pu_gn_div&quot;</span><span class="punctuation">,</span> midpoint <span class="operator">=</span> <span class="number">28000</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/colpal-1.png" alt="Examples of categorical, sequential and diverging palettes." width="75%">
<p class="caption">
(#fig:colpal)Examples of categorical, sequential and diverging palettes.
</p>
</div>
<p>There are two important principles for consideration when working
with colors: perceptibility and accessibility. Firstly, colors on maps
should match our perception. This means that certain colors are viewed
through our experience and also cultural lenses. For example, green
colors usually represent vegetation or lowlands and blue is connected
with water or cool. Color palettes should also be easy to understand to
effectively convey information. It should be clear which values are
lower and which are higher, and colors should change gradually.
<!--toDo:jn--> <!-- update and improve -->
<!-- This property is not preserved in the rainbow color palette; therefore, we suggest avoiding it in geographic data visualization. -->
<!-- Instead, [the viridis color palettes](https://cran.r-project.org/web/packages/viridis/), also available in **tmap**, can be used. -->
Secondly, changes in colors should be accessible to the largest number
of people. Therefore, it is important to use colorblind friendly
palettes as often as possible.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<h2 id="图例">图例</h2>
<p> After we decided on our visual variable and its properties, we
should move our attention toward the related map legend style. Using the
<code>tm_legend()</code> function, we may change its title, position,
orientation, or even disable it. The most important argument in this
function is <code>title</code>, which sets the title of the associated
legend. In general, a map legend title should provide two pieces of
information: what the legend represents and what are the units of the
presented variable. The following code chunk demonstrates this
functionality by providing a more attractive name than the variable name
<code>Land_area</code> (note the use of <code>expression()</code> to
create superscript text):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">legend_title <span class="operator">=</span> <span class="built_in">expression</span><span class="punctuation">(</span><span class="string">&quot;Area (km&quot;</span><span class="operator">^</span><span class="number">2</span><span class="operator">*</span><span class="string">&quot;)&quot;</span><span class="punctuation">)</span></span><br><span class="line">map_nza <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_polygons<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;Land_area&quot;</span><span class="punctuation">,</span> fill.legend <span class="operator">=</span> tm_legend<span class="punctuation">(</span>title <span class="operator">=</span> legend_title<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>The default legend orientation in <strong>tmap</strong> is
<code>"portrait"</code>, however, an alternative legend orientation,
<code>"landscape"</code>, is also possible. Other than that, we can also
customize the location of the legend using the <code>position</code>
argument.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">map_nza2 <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_polygons<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;Land_area&quot;</span><span class="punctuation">,</span> fill.legend <span class="operator">=</span> tm_legend<span class="punctuation">(</span>title <span class="operator">=</span> legend_title<span class="punctuation">,</span></span><br><span class="line">                                                          orientation <span class="operator">=</span> <span class="string">&quot;landscape&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                                          position <span class="operator">=</span> tm_pos_out<span class="punctuation">(</span><span class="string">&quot;center&quot;</span><span class="punctuation">,</span> <span class="string">&quot;bottom&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>The legend position (and also the position of several other map
elements in <strong>tmap</strong>) can be customized using one of a few
functions. The two most important are:</p>
<ul>
<li><code>tm_pos_out()</code>: the default, adds the legend outside of
the map frame area. We can customize its location with two values that
represent the horizontal position (<code>"left"</code>,
<code>"center"</code>, or <code>"right"</code>), and the vertical
position (<code>"bottom"</code>, <code>"center"</code>, or
<code>"top"</code>)</li>
<li><code>tm_pos_in()</code>: puts the legend inside of the map frame
area. We may decided on its position using two arguments, where the
first one can be <code>"left"</code>, <code>"center"</code>, or
<code>"right"</code>, and the second one can be <code>"bottom"</code>,
<code>"center"</code>, or <code>"top"</code>.</li>
</ul>
<p>Alternatively, we may just provide a vector of two values (or two
numbers between 0 and 1) here -- and in such case, the legend will be
put inside the map frame.</p>
<h2 id="布局">布局</h2>
<p> The map layout refers to the combination of all map elements into a
cohesive map. Map elements include among others the objects to be
mapped, the title, the scale bar, the map grid, and margins, while the
color settings covered in the previous section relate to the palette and
break-points used to affect how the map looks. Both may result in subtle
changes that can have an equally large impact on the impression left by
your maps.</p>
<p>Additional map elements such as graticules , north arrows, scale bars
and map titles have their own functions: <code>tm_graticules()</code>,
<code>tm_compass()</code>, <code>tm_scalebar()</code>, and
<code>tm_title()</code> (Figure @ref(fig:na-sb)).<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">map_nz <span class="operator">+</span> </span><br><span class="line">  tm_graticules<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_compass<span class="punctuation">(</span>type <span class="operator">=</span> <span class="string">&quot;8star&quot;</span><span class="punctuation">,</span> position <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;left&quot;</span><span class="punctuation">,</span> <span class="string">&quot;top&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_scalebar<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">100</span><span class="punctuation">,</span> <span class="number">200</span><span class="punctuation">)</span><span class="punctuation">,</span> text.size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> position <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;left&quot;</span><span class="punctuation">,</span> <span class="string">&quot;top&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_title<span class="punctuation">(</span><span class="string">&quot;New Zealand&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/na-sb-1.png" alt="Map with additional elements - a north arrow and scale bar." width="65%">
<p class="caption">
(#fig:na-sb)Map with additional elements - a north arrow and scale bar.
</p>
</div>
<p><strong>tmap</strong> also allows a wide variety of layout settings
to be changed, some of which, produced using the following code (see
<code>args(tm_layout)</code> or <code>?tm_layout</code> for a full
list), are illustrated in Figure @ref(fig:layout1):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">map_nz <span class="operator">+</span> tm_layout<span class="punctuation">(</span>scale <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span></span><br><span class="line">map_nz <span class="operator">+</span> tm_layout<span class="punctuation">(</span>bg.color <span class="operator">=</span> <span class="string">&quot;lightblue&quot;</span><span class="punctuation">)</span></span><br><span class="line">map_nz <span class="operator">+</span> tm_layout<span class="punctuation">(</span>frame <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/layout1-1.png" alt="Layout options specified by (from left to right) title, scale, bg.color and frame arguments." width="100%">
<p class="caption">
(#fig:layout1)Layout options specified by (from left to right) title,
scale, bg.color and frame arguments.
</p>
</div>
<p>The other arguments in <code>tm_layout()</code> provide control over
many more aspects of the map in relation to the canvas on which it is
placed. Here are some useful layout settings (some of which are
illustrated in Figure @ref(fig:layout2)):</p>
<ul>
<li>Margin settings including <code>outer.margin</code> and
<code>inner.margin</code></li>
<li>Font settings controlled by <code>fontface</code> and
<code>fontfamily</code></li>
<li>Legend settings including options such as <code>legend.show</code>
(whether or not to show the legend) <code>legend.orientation</code>,
<code>legend.position</code>, and <code>legend.frame</code></li>
<li>Frame width (<code>frame.lwd</code>) and an option to allow double
lines (<code>frame.double.line</code>)</li>
<li>Color settings controlling <code>color.sepia.intensity</code> (how
<em>yellowy</em> the map looks) and <code>color.saturation</code> (a
color-grayscale)</li>
</ul>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/layout2-1.png" alt="Illustration of selected layout options." width="100%">
<p class="caption">
(#fig:layout2)Illustration of selected layout options.
</p>
</div>
<h2 id="地图分面">地图分面</h2>
<p> Faceted maps, also referred to as 'small multiples', are composed of
many maps arranged side-by-side, and sometimes stacked vertically.
Facets enable the visualization of how spatial relationships change with
respect to another variable, such as time. The changing populations of
settlements, for example, can be represented in a faceted map with each
panel representing the population at a particular moment in time. The
time dimension could be represented via another <em>visual variable</em>
such as color. However, this risks cluttering the map because it will
involve multiple overlapping points (cities do not tend to move over
time!).</p>
<p>Typically all individual facets in a faceted map contain the same
geometry data repeated multiple times, once for each column in the
attribute data (this is the default plotting method for <code>sf</code>
objects, see Chapter @ref(spatial-class)). However, facets can also
represent shifting geometries such as the evolution of a point pattern
over time. This use case of faceted plot is illustrated in Figure
@ref(fig:urban-facet).</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">urb_1970_2030 <span class="operator">=</span> urban_agglomerations <span class="operator">|&gt;</span> </span><br><span class="line">  filter<span class="punctuation">(</span>year <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1970</span><span class="punctuation">,</span> <span class="number">1990</span><span class="punctuation">,</span> <span class="number">2010</span><span class="punctuation">,</span> <span class="number">2030</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">tm_shape<span class="punctuation">(</span>world<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_polygons<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_shape<span class="punctuation">(</span>urb_1970_2030<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_symbols<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="string">&quot;population_millions&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_facets_wrap<span class="punctuation">(</span>by <span class="operator">=</span> <span class="string">&quot;year&quot;</span><span class="punctuation">,</span> nrow <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/urban-facet-1.png" alt="Faceted map showing the top 30 largest urban agglomerations from 1970 to 2030 based on population projections by the United Nations." width="100%">
<p class="caption">
(#fig:urban-facet)Faceted map showing the top 30 largest urban
agglomerations from 1970 to 2030 based on population projections by the
United Nations.
</p>
</div>
<p>The preceding code chunk demonstrates key features of faceted maps
created using the <code>tm_facets_wrap()</code> function:</p>
<ul>
<li>Shapes that do not have a facet variable are repeated (the countries
in <code>world</code> in this case)</li>
<li>The <code>by</code> argument which varies depending on a variable
(<code>"year"</code> in this case)</li>
<li>The <code>nrow</code>/<code>ncol</code> setting specifying the
number of rows and columns that facets should be arranged into</li>
</ul>
<p>Alternatively, it is possible to use the
<code>tm_facets_grid()</code> function that allows to have facets based
on up to three different variables: one for <code>rows</code>, one for
<code>columns</code>, and possibly one for <code>pages</code>.</p>
<p>In addition to their utility for showing changing spatial
relationships, faceted maps are also useful as the foundation for
animated maps (see Section @ref(animated-maps)).</p>
<h2 id="插图地图">插图地图</h2>
<p> An inset map is a smaller map rendered within or next to the main
map. It could serve many different purposes, including providing a
context (Figure @ref(fig:insetmap1)) or bringing some non-contiguous
regions closer to ease their comparison (Figure @ref(fig:insetmap2)).
They could be also used to focus on a smaller area in more detail or to
cover the same area as the map, but representing a different topic.</p>
<p>In the example below, we create a map of the central part of New
Zealand's Southern Alps. Our inset map will show where the main map is
in relation to the whole New Zealand. The first step is to define the
area of interest, which can be done by creating a new spatial object,
<code>nz_region</code>.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nz_region <span class="operator">=</span> st_bbox<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span>xmin <span class="operator">=</span> <span class="number">1340000</span><span class="punctuation">,</span> xmax <span class="operator">=</span> <span class="number">1450000</span><span class="punctuation">,</span></span><br><span class="line">                      ymin <span class="operator">=</span> <span class="number">5130000</span><span class="punctuation">,</span> ymax <span class="operator">=</span> <span class="number">5210000</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                    crs <span class="operator">=</span> st_crs<span class="punctuation">(</span>nz_height<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  st_as_sfc<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>In the second step, we create a base map showing the New Zealand's
Southern Alps area. This is a place where the most important message is
stated.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nz_height_map <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz_elev<span class="punctuation">,</span> bbox <span class="operator">=</span> nz_region<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_raster<span class="punctuation">(</span>col.scale <span class="operator">=</span> tm_scale_continuous<span class="punctuation">(</span>values <span class="operator">=</span> <span class="string">&quot;YlGn&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">            col.legend <span class="operator">=</span> tm_legend<span class="punctuation">(</span>position <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;left&quot;</span><span class="punctuation">,</span> <span class="string">&quot;top&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_shape<span class="punctuation">(</span>nz_height<span class="punctuation">)</span> <span class="operator">+</span> tm_symbols<span class="punctuation">(</span>shape <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_scalebar<span class="punctuation">(</span>position <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;left&quot;</span><span class="punctuation">,</span> <span class="string">&quot;bottom&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>The third step consists of the inset map creation. It gives a context
and helps to locate the area of interest. Importantly, this map needs to
clearly indicate the location of the main map, for example by stating
its borders.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nz_map <span class="operator">=</span> tm_shape<span class="punctuation">(</span>nz<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_shape<span class="punctuation">(</span>nz_height<span class="punctuation">)</span> <span class="operator">+</span> tm_symbols<span class="punctuation">(</span>shape <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> size <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  tm_shape<span class="punctuation">(</span>nz_region<span class="punctuation">)</span> <span class="operator">+</span> tm_borders<span class="punctuation">(</span>lwd <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_layout<span class="punctuation">(</span>bg.color <span class="operator">=</span> <span class="string">&quot;lightblue&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>One of the main differences between regular charts (e.g.,
scatterplots) and maps is that the input data determine the aspect ratio
of maps. Thus, in this case, we need to calculate the aspect ratios of
our two main datasets, <code>nz_region</code> and <code>nz</code>. The
following function, <code>norm_dim()</code> returns the normalized width
(<code>"w"</code>) and height (<code>"h"</code>) of the object (as
<code>"snpc"</code> units understood my the graphic device).</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>grid<span class="punctuation">)</span></span><br><span class="line">norm_dim <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>obj<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">    bbox <span class="operator">=</span> st_bbox<span class="punctuation">(</span>obj<span class="punctuation">)</span></span><br><span class="line">    width <span class="operator">=</span> bbox<span class="punctuation">[[</span><span class="string">&quot;xmax&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">-</span> bbox<span class="punctuation">[[</span><span class="string">&quot;xmin&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">    height <span class="operator">=</span> bbox<span class="punctuation">[[</span><span class="string">&quot;ymax&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">-</span> bbox<span class="punctuation">[[</span><span class="string">&quot;ymin&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">    w <span class="operator">=</span> width <span class="operator">/</span> <span class="built_in">max</span><span class="punctuation">(</span>width<span class="punctuation">,</span> height<span class="punctuation">)</span></span><br><span class="line">    h <span class="operator">=</span> height <span class="operator">/</span> <span class="built_in">max</span><span class="punctuation">(</span>width<span class="punctuation">,</span> height<span class="punctuation">)</span></span><br><span class="line">    <span class="built_in">return</span><span class="punctuation">(</span>unit<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span>w<span class="punctuation">,</span> h<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;snpc&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">main_dim <span class="operator">=</span> norm_dim<span class="punctuation">(</span>nz_region<span class="punctuation">)</span></span><br><span class="line">ins_dim <span class="operator">=</span> norm_dim<span class="punctuation">(</span>nz<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>Next, knowing the aspect ratios, we need to specify the sizes and
locations of our two maps -- the main map and the inset map -- using the
<code>viewport()</code> function. A viewport is part of a graphics
device we use to draw the graphical elements at a given moment. The
viewport of our main map is just the representation of its aspect
ratio.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">main_vp <span class="operator">=</span> viewport<span class="punctuation">(</span>width <span class="operator">=</span> main_dim<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span> height <span class="operator">=</span> main_dim<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>On the other hand, the viewport of the inset map needs to specify its
size and location. Here, we would make the inset map twice smaller as
the main one by multiplying the width and height by 0.5, and we will
locate it 0.5 cm from the bottom right of the main map frame.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ins_vp <span class="operator">=</span> viewport<span class="punctuation">(</span>width <span class="operator">=</span> ins_dim<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="number">0.5</span><span class="punctuation">,</span> height <span class="operator">=</span> ins_dim<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                  x <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="string">&quot;npc&quot;</span><span class="punctuation">)</span> <span class="operator">-</span> unit<span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> y <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                  just <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;right&quot;</span><span class="punctuation">,</span> <span class="string">&quot;bottom&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>Finally, we combine the two maps by creating a new, blank canvas,
printing out the main map, and then placing the inset map inside of the
main map viewport.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grid.newpage<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">print<span class="punctuation">(</span>nz_height_map<span class="punctuation">,</span> vp <span class="operator">=</span> main_vp<span class="punctuation">)</span></span><br><span class="line">pushViewport<span class="punctuation">(</span>main_vp<span class="punctuation">)</span></span><br><span class="line">print<span class="punctuation">(</span>nz_map<span class="punctuation">,</span> vp <span class="operator">=</span> ins_vp<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/insetmap1-1.png" alt="Inset map providing a context - location of the central part of the Southern Alps in New Zealand." width="100%">
<p class="caption">
(#fig:insetmap1)Inset map providing a context - location of the central
part of the Southern Alps in New Zealand.
</p>
</div>
<p>Inset map can be saved to file either by using a graphic device (see
Section @ref(visual-outputs)) or the <code>tmap_save()</code> function
and its arguments - <code>insets_tm</code> and
<code>insets_vp</code>.</p>
<p>Inset maps are also used to create one map of non-contiguous areas.
Probably, the most often used example is a map of the United States,
which consists of the contiguous United States, Hawaii and Alaska. It is
very important to find the best projection for each individual inset in
these types of cases (see Chapter @ref(reproj-geo-data) to learn more).
We can use US National Atlas Equal Area for the map of the contiguous
United States by putting its EPSG code in the <code>projection</code>
argument of <code>tm_shape()</code>.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">us_states_map <span class="operator">=</span> tm_shape<span class="punctuation">(</span>us_states<span class="punctuation">,</span> projection <span class="operator">=</span> <span class="string">&quot;EPSG:2163&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  tm_layout<span class="punctuation">(</span>frame <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>The rest of our objects, <code>hawaii</code> and <code>alaska</code>,
already have proper projections; therefore, we just need to create two
separate maps:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hawaii_map <span class="operator">=</span> tm_shape<span class="punctuation">(</span>hawaii<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_polygons<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  tm_title<span class="punctuation">(</span><span class="string">&quot;Hawaii&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_layout<span class="punctuation">(</span>frame <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> bg.color <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> </span><br><span class="line">            title.position <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;LEFT&quot;</span><span class="punctuation">,</span> <span class="string">&quot;BOTTOM&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">alaska_map <span class="operator">=</span> tm_shape<span class="punctuation">(</span>alaska<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_polygons<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  tm_title<span class="punctuation">(</span><span class="string">&quot;Alaska&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_layout<span class="punctuation">(</span>frame <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> bg.color <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>The final map is created by combining and arranging these three
maps:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">us_states_map</span><br><span class="line">print<span class="punctuation">(</span>hawaii_map<span class="punctuation">,</span> vp <span class="operator">=</span> grid<span class="operator">::</span>viewport<span class="punctuation">(</span><span class="number">0.35</span><span class="punctuation">,</span> <span class="number">0.1</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">print<span class="punctuation">(</span>alaska_map<span class="punctuation">,</span> vp <span class="operator">=</span> grid<span class="operator">::</span>viewport<span class="punctuation">(</span><span class="number">0.15</span><span class="punctuation">,</span> <span class="number">0.15</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">0.3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/insetmap2-1.png" alt="Map of the United States." width="100%">
<p class="caption">
(#fig:insetmap2)Map of the United States.
</p>
</div>
<p>The code presented above is compact and can be used as the basis for
other inset maps but the results, in Figure @ref(fig:insetmap2), provide
a poor representation of the locations of Hawaii and Alaska. For a more
in-depth approach, see the <a target="_blank" rel="external nofollow noopener noreferrer" href="https://geocompx.github.io/geocompkg/articles/us-map.html"><code>us-map</code></a>
vignette from the <strong>geocompkg</strong>.</p>
<h1 id="动画地图">动画地图</h1>
<p> Faceted maps, described in Section @ref(faceted-maps), can show how
spatial distributions of variables change (e.g., over time), but the
approach has disadvantages. Facets become tiny when there are many of
them. Furthermore, the fact that each facet is physically separated on
the screen or page means that subtle differences between facets can be
hard to detect.</p>
<p>Animated maps solve these issues. Although they depend on digital
publication, this is becoming less of an issue as more and more content
moves online. Animated maps can still enhance paper reports: you can
always link readers to a web-page containing an animated (or
interactive) version of a printed map to help make it come alive. There
are several ways to generate animations in R, including with animation
packages such as <strong>gganimate</strong>, which builds on
<strong>ggplot2</strong> (see Section @ref(other-mapping-packages)).
This section focuses on creating animated maps with
<strong>tmap</strong> because its syntax will be familiar from previous
sections and the flexibility of the approach.</p>
<p>Figure @ref(fig:urban-animated) is a simple example of an animated
map. Unlike the faceted plot, it does not squeeze multiple maps into a
single screen and allows the reader to see how the spatial distribution
of the world's most populous agglomerations evolve over time (see the
book's website for the animated version).</p>
<div class="figure" style="text-align: center">
<img data-src="figures/urban-animated.gif" alt="Animated map showing the top 30 largest urban agglomerations from 1950 to 2030 based on population projects by the United Nations. Animated version available online at: r.geocompx.org." width="100%">
<p class="caption">
(#fig:urban-animated)Animated map showing the top 30 largest urban
agglomerations from 1950 to 2030 based on population projects by the
United Nations. Animated version available online at: r.geocompx.org.
</p>
</div>
<p>The animated map illustrated in Figure @ref(fig:urban-animated) can
be created using the same <strong>tmap</strong> techniques that generate
faceted maps, demonstrated in Section @ref(faceted-maps). There are two
differences, however, related to arguments in
<code>tm_facets()</code>:</p>
<ul>
<li><code>nrow = 1, ncol = 1</code> are added to keep one moment in time
as one layer</li>
<li><code>free.coords = FALSE</code>, which maintains the map extent for
each map iteration</li>
</ul>
<p>These additional arguments are demonstrated in the subsequent code
chunk<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urb_anim <span class="operator">=</span> tm_shape<span class="punctuation">(</span>world<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  tm_shape<span class="punctuation">(</span>urban_agglomerations<span class="punctuation">)</span> <span class="operator">+</span> tm_symbols<span class="punctuation">(</span>size <span class="operator">=</span> <span class="string">&quot;population_millions&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  tm_facets<span class="punctuation">(</span>by <span class="operator">=</span> <span class="string">&quot;year&quot;</span><span class="punctuation">,</span> nrow <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> free.coords <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>The resulting <code>urb_anim</code> represents a set of separate maps
for each year. The final stage is to combine them and save the result as
a <code>.gif</code> file with <code>tmap_animation()</code>. The
following command creates the animation illustrated in Figure
@ref(fig:urban-animated), with a few elements missing, that we will add
in during the exercises:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tmap_animation<span class="punctuation">(</span>urb_anim<span class="punctuation">,</span> filename <span class="operator">=</span> <span class="string">&quot;urb_anim.gif&quot;</span><span class="punctuation">,</span> delay <span class="operator">=</span> <span class="number">25</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>Another illustration of the power of animated maps is provided in
Figure @ref(fig:animus). This shows the development of states in the
United States, which first formed in the east and then incrementally to
the west and finally into the interior. Code to reproduce this map can
be found in the script <code>09-usboundaries.R</code>.</p>
<div class="figure" style="text-align: center">
<img data-src="https://user-images.githubusercontent.com/1825120/38543030-5794b6f0-3c9b-11e8-9da9-10ec1f3ea726.gif" alt="Animated map showing population growth, state formation and boundary changes in the United States, 1790-2010. Animated version available online at r.geocompx.org." width="100%">
<p class="caption">
(#fig:animus)Animated map showing population growth, state formation and
boundary changes in the United States, 1790-2010. Animated version
available online at r.geocompx.org.
</p>
</div>
<h1 id="交互地图">交互地图</h1>
<p> While static and animated maps can enliven geographic datasets,
interactive maps can take them to a new level. Interactivity can take
many forms, the most common and useful of which is the ability to pan
around and zoom into any part of a geographic dataset overlaid on a 'web
map' to show context. Less advanced interactivity levels include popups
which appear when you click on different features, a kind of interactive
label. More advanced levels of interactivity include the ability to tilt
and rotate maps, as demonstrated in the <strong>mapdeck</strong> example
below, and the provision of "dynamically linked" sub-plots which
automatically update when the user pans and zooms.</p>
<p>The most important type of interactivity, however, is the display of
geographic data on interactive or 'slippy' web maps. The release of the
<strong>leaflet</strong> package in 2015 (that uses the leaflet
JavaScript library) revolutionized interactive web map creation from
within R and a number of packages have built on these foundations adding
new features (e.g., <strong>leaflet.extras</strong>) and making the
creation of web maps as simple as creating static maps (e.g.,
<strong>mapview</strong> and <strong>tmap</strong>). This section
illustrates each approach in the opposite order. We will explore how to
make slippy maps with <strong>tmap</strong> (the syntax of which we have
already learned), <strong>mapview</strong>, <strong>mapdeck</strong> and
finally <strong>leaflet</strong> (which provides low-level control over
interactive maps).</p>
<p>A unique feature of <strong>tmap</strong> mentioned in Section
@ref(static-maps) is its ability to create static and interactive maps
using the same code. Maps can be viewed interactively at any point by
switching to view mode, using the command
<code>tmap_mode("view")</code>. This is demonstrated in the code below,
which creates an interactive map of New Zealand based on the
<code>tmap</code> object <code>map_nz</code>, created in Section
@ref(map-obj), and illustrated in Figure @ref(fig:tmview):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tmap_mode<span class="punctuation">(</span><span class="string">&quot;view&quot;</span><span class="punctuation">)</span></span><br><span class="line">map_nz</span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<iframe src="https://geocompx.org/static/img/tmview-1.html" width="100%" height="400px" data-external="1">
</iframe>
<p class="caption">
(#fig:tmview)Interactive map of New Zealand created with tmap in view
mode. Interactive version available online at: r.geocompx.org.
</p>
</div>
<!--toDo:jn-->
<!-- tmap_leaflet? -->
<p>Now that the interactive mode has been 'turned on', all maps produced
with <strong>tmap</strong> will launch (another way to create
interactive maps is with the <code>tmap_leaflet()</code> function).
Notable features of this interactive mode include the ability to specify
the basemap with <code>tm_basemap()</code> (or
<code>tmap_options()</code>) as demonstrated below (result not
shown):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map_nz <span class="operator">+</span> tm_basemap<span class="punctuation">(</span>server <span class="operator">=</span> <span class="string">&quot;OpenTopoMap&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>An impressive and little-known feature of <strong>tmap</strong>'s
view mode is that it also works with faceted plots. The argument
<code>sync</code> in <code>tm_facets()</code> can be used in this case
to produce multiple maps with synchronized zoom and pan settings, as
illustrated in Figure @ref(fig:sync), which was produced by the
following code:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">world_coffee <span class="operator">=</span> left_join<span class="punctuation">(</span>world<span class="punctuation">,</span> coffee_data<span class="punctuation">,</span> by <span class="operator">=</span> <span class="string">&quot;name_long&quot;</span><span class="punctuation">)</span></span><br><span class="line">facets <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;coffee_production_2016&quot;</span><span class="punctuation">,</span> <span class="string">&quot;coffee_production_2017&quot;</span><span class="punctuation">)</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>world_coffee<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span>facets<span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  tm_facets_wrap<span class="punctuation">(</span>nrow <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> sync <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="figures/interactive-facets.png" alt="Faceted interactive maps of global coffee production in 2016 and 2017 in sync, demonstrating tmap's view mode in action." width="100%">
<p class="caption">
(#fig:sync)Faceted interactive maps of global coffee production in 2016
and 2017 in sync, demonstrating tmap's view mode in action.
</p>
</div>
<p>Switch <strong>tmap</strong> back to plotting mode with the same
function:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tmap_mode<span class="punctuation">(</span><span class="string">&quot;plot&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; tmap mode set to &#x27;plot&#x27;</span></span><br></pre></td></tr></table></figure>
<p>If you are not proficient with <strong>tmap</strong>, the quickest
way to create interactive maps in R may be with
<strong>mapview</strong>. The following 'one liner' is a reliable way to
interactively explore a wide range of geographic data formats:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapview<span class="operator">::</span>mapview<span class="punctuation">(</span>nz<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="figures/mapview.png" alt="Illustration of mapview in action." width="100%">
<p class="caption">
(#fig:mapview)Illustration of mapview in action.
</p>
</div>
<p><strong>mapview</strong> has a concise syntax yet is powerful. By
default, it has some standard GIS functionality such as mouse position
information, attribute queries (via pop-ups), scale bar, and
zoom-to-layer buttons. It also offers advanced controls including the
ability to 'burst' datasets into multiple layers and the addition of
multiple layers with <code>+</code> followed by the name of a geographic
object. Additionally, it provides automatic coloring of attributes via
the <code>zcol</code> argument. In essence, it can be considered a
data-driven <strong>leaflet</strong> API (see below for more information
about <strong>leaflet</strong>). Given that <strong>mapview</strong>
always expects a spatial object (including <code>sf</code> and
<code>SpatRaster</code>) as its first argument, it works well at the end
of piped expressions. Consider the following example where
<strong>sf</strong> is used to intersect lines and polygons and then is
visualized with <strong>mapview</strong> (Figure
@ref(fig:mapview2)).</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>mapview<span class="punctuation">)</span></span><br><span class="line">oberfranken <span class="operator">=</span> subset<span class="punctuation">(</span>franconia<span class="punctuation">,</span> district <span class="operator">==</span> <span class="string">&quot;Oberfranken&quot;</span><span class="punctuation">)</span></span><br><span class="line">trails <span class="operator">|&gt;</span></span><br><span class="line">  st_transform<span class="punctuation">(</span>st_crs<span class="punctuation">(</span>oberfranken<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  st_intersection<span class="punctuation">(</span>oberfranken<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  st_collection_extract<span class="punctuation">(</span><span class="string">&quot;LINESTRING&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  mapview<span class="punctuation">(</span>color <span class="operator">=</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> lwd <span class="operator">=</span> <span class="number">3</span><span class="punctuation">,</span> layer.name <span class="operator">=</span> <span class="string">&quot;trails&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  mapview<span class="punctuation">(</span>franconia<span class="punctuation">,</span> zcol <span class="operator">=</span> <span class="string">&quot;district&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  breweries</span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="figures/mapview-example.png" alt="Using mapview at the end of a sf-based pipe expression." width="100%">
<p class="caption">
(#fig:mapview2)Using mapview at the end of a sf-based pipe expression.
</p>
</div>
<p>One important thing to keep in mind is that <strong>mapview</strong>
layers are added via the <code>+</code> operator (similar to
<strong>ggplot2</strong> or <strong>tmap</strong>). By default,
<strong>mapview</strong> uses the leaflet JavaScript library to render
the output maps, which is user-friendly and has a lot of features.
However, some alternative rendering libraries could be more performant
(work more smoothly on larger datasets). <strong>mapview</strong> allows
to set alternative rendering libraries (<code>"leafgl"</code> and
<code>"mapdeck"</code>) in the <code>mapviewOptions()</code>.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> For further information on
<strong>mapview</strong>, see the package's website at: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://r-spatial.github.io/mapview/articles/">r-spatial.github.io/mapview/</a>.</p>
<p>There are other ways to create interactive maps with R. The
<strong>googleway</strong> package, for example, provides an interactive
mapping interface that is flexible and extensible (see the <a target="_blank" rel="external nofollow noopener noreferrer" href="https://cran.r-project.org/web/packages/googleway/vignettes/googleway-vignette.html"><code>googleway-vignette</code></a>
for details). Another approach by the same author is <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/SymbolixAU/mapdeck"><strong>mapdeck</strong></a>,
which provides access to Uber's <code>Deck.gl</code> framework. Its use
of WebGL enables it to interactively visualize large datasets up to
millions of points. The package uses Mapbox <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.mapbox.com/help/getting-started/access-tokens/">access
tokens</a>, which you must register for before using the package.</p>

<div class="rmdnote">
Note that the following block assumes the access token is stored in your
R environment as <code>MAPBOX=your_unique_key</code>. This can be added
with <code>usethis::edit_r_environ()</code>.
</div>
<p>A unique feature of <strong>mapdeck</strong> is its provision of
interactive 2.5D perspectives, illustrated in Figure @ref(fig:mapdeck).
This means you can can pan, zoom and rotate around the maps, and view
the data 'extruded' from the map. Figure @ref(fig:mapdeck), generated by
the following code chunk, visualizes road traffic crashes in the UK,
with bar height representing casualties per area.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>mapdeck<span class="punctuation">)</span></span><br><span class="line">set_token<span class="punctuation">(</span>Sys.getenv<span class="punctuation">(</span><span class="string">&quot;MAPBOX&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">crash_data <span class="operator">=</span> read.csv<span class="punctuation">(</span><span class="string">&quot;https://git.io/geocompr-mapdeck&quot;</span><span class="punctuation">)</span></span><br><span class="line">crash_data <span class="operator">=</span> na.omit<span class="punctuation">(</span>crash_data<span class="punctuation">)</span></span><br><span class="line">ms <span class="operator">=</span> mapdeck_style<span class="punctuation">(</span><span class="string">&quot;dark&quot;</span><span class="punctuation">)</span></span><br><span class="line">mapdeck<span class="punctuation">(</span>style <span class="operator">=</span> ms<span class="punctuation">,</span> pitch <span class="operator">=</span> <span class="number">45</span><span class="punctuation">,</span> location <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">52</span><span class="punctuation">)</span><span class="punctuation">,</span> zoom <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  add_grid<span class="punctuation">(</span>data <span class="operator">=</span> crash_data<span class="punctuation">,</span> lat <span class="operator">=</span> <span class="string">&quot;lat&quot;</span><span class="punctuation">,</span> lon <span class="operator">=</span> <span class="string">&quot;lng&quot;</span><span class="punctuation">,</span> cell_size <span class="operator">=</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">           elevation_scale <span class="operator">=</span> <span class="number">50</span><span class="punctuation">,</span> colour_range <span class="operator">=</span> hcl.colors<span class="punctuation">(</span><span class="number">6</span><span class="punctuation">,</span> <span class="string">&quot;plasma&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="figures/mapdeck-mini.png" alt="Map generated by mapdeck, representing road traffic casualties across the UK. Height of 1 km cells represents number of crashes." width="100%">
<p class="caption">
(#fig:mapdeck)Map generated by mapdeck, representing road traffic
casualties across the UK. Height of 1 km cells represents number of
crashes.
</p>
</div>
<p>You can zoom and drag the map in the browser, in addition to rotating
and tilting it when pressing <code>Cmd</code>/<code>Ctrl</code>.
Multiple layers can be added with the pipe operator, as demonstrated in
the <a target="_blank" rel="external nofollow noopener noreferrer" href="https://cran.r-project.org/web/packages/mapdeck/vignettes/mapdeck.html"><code>mapdeck</code>
vignettes</a>. <strong>mapdeck</strong> also supports <code>sf</code>
objects, as can be seen by replacing the <code>add_grid()</code>
function call in the preceding code chunk with
<code>add_polygon(data = lnd, layer_id = "polygon_layer")</code>, to add
polygons representing London to an interactive tilted map.</p>
<p>Last but not least is <strong>leaflet</strong> which is the most
mature and widely used interactive mapping package in R.
<strong>leaflet</strong> provides a relatively low-level interface to
the Leaflet JavaScript library and many of its arguments can be
understood by reading the documentation of the original JavaScript
library (see <a target="_blank" rel="external nofollow noopener noreferrer" href="https://leafletjs.com/">leafletjs.com</a>).</p>
<p>Leaflet maps are created with <code>leaflet()</code>, the result of
which is a <code>leaflet</code> map object which can be piped to other
<strong>leaflet</strong> functions. This allows multiple map layers and
control settings to be added interactively, as demonstrated in the code
below which generates Figure @ref(fig:leaflet) (see <a target="_blank" rel="external nofollow noopener noreferrer" href="https://rstudio.github.io/leaflet/">rstudio.github.io/leaflet/</a>
for details).</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pal <span class="operator">=</span> colorNumeric<span class="punctuation">(</span><span class="string">&quot;RdYlBu&quot;</span><span class="punctuation">,</span> domain <span class="operator">=</span> cycle_hire<span class="operator">$</span>nbikes<span class="punctuation">)</span></span><br><span class="line">leaflet<span class="punctuation">(</span>data <span class="operator">=</span> cycle_hire<span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  addProviderTiles<span class="punctuation">(</span>providers<span class="operator">$</span>CartoDB.Positron<span class="punctuation">)</span> <span class="operator">|&gt;</span></span><br><span class="line">  addCircles<span class="punctuation">(</span>col <span class="operator">=</span> <span class="operator">~</span>pal<span class="punctuation">(</span>nbikes<span class="punctuation">)</span><span class="punctuation">,</span> opacity <span class="operator">=</span> <span class="number">0.9</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  addPolygons<span class="punctuation">(</span>data <span class="operator">=</span> lnd<span class="punctuation">,</span> fill <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  addLegend<span class="punctuation">(</span>pal <span class="operator">=</span> pal<span class="punctuation">,</span> values <span class="operator">=</span> <span class="operator">~</span>nbikes<span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  setView<span class="punctuation">(</span>lng <span class="operator">=</span> <span class="operator">-</span><span class="number">0.1</span><span class="punctuation">,</span> <span class="number">51.5</span><span class="punctuation">,</span> zoom <span class="operator">=</span> <span class="number">12</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  addMiniMap<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="figures/leaflet-1.png" alt="The leaflet package in action, showing cycle hire points in London. See interactive version [online](https://geocompr.github.io/img/leaflet.html)." width="100%">
<p class="caption">
(#fig:leaflet)The leaflet package in action, showing cycle hire points
in London. See interactive version <a target="_blank" rel="external nofollow noopener noreferrer" href="https://geocompr.github.io/img/leaflet.html">online</a>.
</p>
</div>
<h1 id="地图应用">地图应用</h1>
<p> The interactive web maps demonstrated in Section
@ref(interactive-maps) can go far. Careful selection of layers to
display, base-maps and pop-ups can be used to communicate the main
results of many projects involving geocomputation. But the web mapping
approach to interactivity has limitations:</p>
<ul>
<li>Although the map is interactive in terms of panning, zooming and
clicking, the code is static, meaning the user interface is fixed</li>
<li>All map content is generally static in a web map, meaning that web
maps cannot scale to handle large datasets easily</li>
<li>Additional layers of interactivity, such a graphs showing
relationships between variables and 'dashboards' are difficult to create
using the web-mapping approach</li>
</ul>
<p>Overcoming these limitations involves going beyond static web mapping
and towards geospatial frameworks and map servers. Products in this
field include <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.djangoproject.com/en/4.0/ref/contrib/gis/">GeoDjango</a>
(which extends the Django web framework and is written in <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/django/django">Python</a>), <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/mapserver/mapserver">MapServer</a> (a framework
for developing web applications, largely written in C and C++) and <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/geoserver/geoserver">GeoServer</a> (a mature
and powerful map server written in Java). Each of these is scalable,
enabling maps to be served to thousands of people daily, assuming there
is sufficient public interest in your maps! The bad news is that such
server-side solutions require much skilled developer time to set-up and
maintain, often involving teams of people with roles such as a dedicated
geospatial database administrator (<a target="_blank" rel="external nofollow noopener noreferrer" href="https://wiki.gis.com/wiki/index.php/Database_administrator">DBA</a>).</p>
<p>Fortunately for R programmers, web mapping applications can now be
rapidly created wih <strong>shiny</strong>. As described in the open
source book <a target="_blank" rel="external nofollow noopener noreferrer" href="https://mastering-shiny.org/">Mastering Shiny</a>,
<strong>shiny</strong> is an R package and framework for converting R
code into interactive web applications. You can embed interactive maps
in shiny apps thanks to functions such as
<code>tmap::renderTmap()</code> and <a target="_blank" rel="external nofollow noopener noreferrer" href="https://rstudio.github.io/leaflet/shiny.html"><code>leaflet::renderLeaflet()</code></a>.
This section gives some context, teaches the basics of
<strong>shiny</strong> from a web mapping perspective and culminates in
a full-screen mapping application in less than 100 lines of code.</p>
<p><strong>shiny</strong> is well documented at <a target="_blank" rel="external nofollow noopener noreferrer" href="https://shiny.rstudio.com/">shiny.rstudio.com</a>, which
highlights the two components of every <strong>shiny</strong> app:
'front end' (the bit the user sees) and 'back end' code. In
<strong>shiny</strong> apps, these elements are typically created in
objects named <code>ui</code> and <code>server</code> within an R script
named <code>app.R</code>, which lives in an 'app folder'. This allows
web mapping applications to be represented in a single file, such as the
<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/geocompx/geocompr/blob/main/apps/CycleHireApp/app.R"><code>CycleHireApp/app.R</code></a>
file in the book's GitHub repo.</p>

<div class="rmdnote">
In <strong>shiny</strong> apps these are often split into
<code>ui.R</code> (short for user interface) and <code>server.R</code>
files, naming conventions used by <code>shiny-server</code>, a
server-side Linux application for serving shiny apps on public-facing
websites. <code>shiny-server</code> also serves apps defined by a single
<code>app.R</code> file in an 'app folder'. Learn more at:
https://github.com/rstudio/shiny-server.
</div>
<p>Before considering large apps, it is worth seeing a minimal example,
named 'lifeApp', in action.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> The code below defines
and launches --- with the command <code>shinyApp()</code> --- a lifeApp,
which provides an interactive slider allowing users to make countries
appear with progressively lower levels of life expectancy (see Figure
@ref(fig:lifeApp)):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>shiny<span class="punctuation">)</span>    <span class="comment"># for shiny apps</span></span><br><span class="line">library<span class="punctuation">(</span>leaflet<span class="punctuation">)</span>  <span class="comment"># renderLeaflet function</span></span><br><span class="line">library<span class="punctuation">(</span>spData<span class="punctuation">)</span>   <span class="comment"># loads the world dataset </span></span><br><span class="line">ui <span class="operator">=</span> fluidPage<span class="punctuation">(</span></span><br><span class="line">  sliderInput<span class="punctuation">(</span>inputId <span class="operator">=</span> <span class="string">&quot;life&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Life expectancy&quot;</span><span class="punctuation">,</span> <span class="number">49</span><span class="punctuation">,</span> <span class="number">84</span><span class="punctuation">,</span> value <span class="operator">=</span> <span class="number">80</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      leafletOutput<span class="punctuation">(</span>outputId <span class="operator">=</span> <span class="string">&quot;map&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">server <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>input<span class="punctuation">,</span> output<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  output<span class="operator">$</span>map <span class="operator">=</span> renderLeaflet<span class="punctuation">(</span><span class="punctuation">&#123;</span></span><br><span class="line">    leaflet<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">      <span class="comment"># addProviderTiles(&quot;OpenStreetMap.BlackAndWhite&quot;) |&gt;</span></span><br><span class="line">      addPolygons<span class="punctuation">(</span>data <span class="operator">=</span> world<span class="punctuation">[</span>world<span class="operator">$</span>lifeExp <span class="operator">&lt;</span> input<span class="operator">$</span>life<span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">&#125;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">shinyApp<span class="punctuation">(</span>ui<span class="punctuation">,</span> server<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="figures/shiny-app.png" alt="Screenshot showing minimal example of a web mapping application created with shiny." width="100%">
<p class="caption">
(#fig:lifeApp)Screenshot showing minimal example of a web mapping
application created with shiny.
</p>
</div>
<p>The <strong>user interface</strong> (<code>ui</code>) of lifeApp is
created by <code>fluidPage()</code>. This contains input and output
'widgets' --- in this case, a <code>sliderInput()</code> (many other
<code>*Input()</code> functions are available) and a
<code>leafletOutput()</code>. These are arranged row-wise by default,
explaining why the slider interface is placed directly above the map in
Figure @ref(fig:lifeApp) (see <code>?column</code> for adding content
column-wise).</p>
<p>The <strong>server side</strong> (<code>server</code>) is a function
with <code>input</code> and <code>output</code> arguments.
<code>output</code> is a list of objects containing elements generated
by <code>render*()</code> function --- <code>renderLeaflet()</code>
which in this example generates <code>output$map</code>. Input elements
such as <code>input$life</code> referred to in the server must relate to
elements that exist in the <code>ui</code> --- defined by
<code>inputId = "life"</code> in the code above. The function
<code>shinyApp()</code> combines both the <code>ui</code> and
<code>server</code> elements and serves the results interactively via a
new R process. When you move the slider in the map shown in Figure
@ref(fig:lifeApp), you are actually causing R code to re-run, although
this is hidden from view in the user interface.</p>
<p>Building on this basic example and knowing where to find help (see
<code>?shiny</code>), the best way forward now may be to stop reading
and start programming! The recommended next step is to open the
previously mentioned <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/geocompx/geocompr/blob/main/apps/CycleHireApp/app.R"><code>CycleHireApp/app.R</code></a>
script in an IDE of choice, modify it and re-run it repeatedly. The
example contains some of the components of a web mapping application
implemented in <strong>shiny</strong> and should 'shine' a light on how
they behave.</p>
<p>The <code>CycleHireApp/app.R</code> script contains
<strong>shiny</strong> functions that go beyond those demonstrated in
the simple 'lifeApp' example. These include <code>reactive()</code> and
<code>observe()</code> (for creating outputs that respond to the user
interface --- see <code>?reactive</code>) and
<code>leafletProxy()</code> (for modifying a <code>leaflet</code> object
that has already been created). Such elements are critical to the
creation of web mapping applications implemented in
<strong>shiny</strong>. A range of 'events' can be programmed including
advanced functionality such as drawing new layers or subsetting data, as
described in the shiny section of RStudio's <strong>leaflet</strong> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://rstudio.github.io/leaflet/shiny.html">website</a>.</p>

<div class="rmdnote">
There are a number of ways to run a <strong>shiny</strong> app. For
RStudio users, the simplest way is probably to click on the 'Run App'
button located in the top right of the source pane when an
<code>app.R</code>, <code>ui.R</code> or <code>server.R</code> script is
open. <strong>shiny</strong> apps can also be initiated by using
<code>runApp()</code> with the first argument being the folder
containing the app code and data: <code>runApp("CycleHireApp")</code> in
this case (which assumes a folder named <code>CycleHireApp</code>
containing the <code>app.R</code> script is in your working directory).
You can also launch apps from a Unix command line with the command
<code>Rscript -e 'shiny::runApp("CycleHireApp")'</code>.
</div>
<p>Experimenting with apps such as <code>CycleHireApp</code> will build
not only your knowledge of web mapping applications in R, but also your
practical skills. Changing the contents of <code>setView()</code>, for
example, will change the starting bounding box that the user sees when
the app is initiated. Such experimentation should not be done at random,
but with reference to relevant documentation, starting with
<code>?shiny</code>, and motivated by a desire to solve problems such as
those posed in the exercises.</p>
<p><strong>shiny</strong> used in this way can make prototyping mapping
applications faster and more accessible than ever before (deploying
<strong>shiny</strong> apps, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://shiny.rstudio.com/deploy/" class="uri">https://shiny.rstudio.com/deploy/</a>, is a separate topic
beyond the scope of this chapter). Even if your applications are
eventually deployed using different technologies, <strong>shiny</strong>
undoubtedly allows web mapping applications to be developed in
relatively few lines of code (86 in the case of CycleHireApp). That does
not stop shiny apps getting rather large. The Propensity to Cycle Tool
(PCT) hosted at <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.pct.bike/">pct.bike</a>, for
example, is a national mapping tool funded by the UK's Department for
Transport. The PCT is used by dozens of people each day and has multiple
interactive elements based on more than 1000 lines of <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/npct/pct-shiny/blob/master/regions_www/m/server.R">code</a>.</p>
<p>While such apps undoubtedly take time and effort to develop,
<strong>shiny</strong> provides a framework for reproducible prototyping
that should aid the development process. One potential problem with the
ease of developing prototypes with <strong>shiny</strong> is the
temptation to start programming too early, before the purpose of the
mapping application has been envisioned in detail. For that reason,
despite advocating <strong>shiny</strong>, we recommend starting with
the longer established technology of a pen and paper as the first stage
for interactive mapping projects. This way your prototype web
applications should be limited not by technical considerations, but by
your motivations and imagination.</p>
<div class="figure" style="text-align: center">
<iframe src="https://shiny.robinlovelace.net/CycleHireApp/?showcase=0" width="690" height="400px" data-external="1">
</iframe>
<p class="caption">
(#fig:CycleHireApp-html)CycleHireApp, a simple web mapping application
for finding the closest cycle hiring station based on your location and
requirement of cycles. Interactive version available online at
r.geocompx.org.
</p>
</div>
<h1 id="其他地图包">其他地图包</h1>
<p><strong>tmap</strong> provides a powerful interface for creating a
wide range of static maps (Section @ref(static-maps)) and also supports
interactive maps (Section @ref(interactive-maps)). But there are many
other options for creating maps in R. The aim of this section is to
provide a taster of some of these and pointers for additional resources:
map making is a surprisingly active area of R package development, so
there is more to learn than can be covered here.</p>
<p>The most mature option is to use <code>plot()</code> methods provided
by core spatial packages <strong>sf</strong> and <strong>terra</strong>,
covered in Sections @ref(basic-map) and @ref(basic-map-raster),
respectively. What we have not mentioned in those sections was that plot
methods for vector and raster objects can be combined when the results
draw onto the same plot area (elements such as keys in
<strong>sf</strong> plots and multi-band rasters will interfere with
this). This behavior is illustrated in the subsequent code chunk which
generates Figure @ref(fig:nz-plot). <code>plot()</code> has many other
options which can be explored by following links in the
<code>?plot</code> help page and the <strong>sf</strong> vignette <a target="_blank" rel="external nofollow noopener noreferrer" href="https://cran.r-project.org/web/packages/sf/vignettes/sf5.html"><code>sf5</code></a>.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">g <span class="operator">=</span> st_graticule<span class="punctuation">(</span>nz<span class="punctuation">,</span> lon <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">170</span><span class="punctuation">,</span> <span class="number">175</span><span class="punctuation">)</span><span class="punctuation">,</span> lat <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">45</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">40</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">35</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">plot<span class="punctuation">(</span>nz_water<span class="punctuation">,</span> graticule <span class="operator">=</span> g<span class="punctuation">,</span> axes <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">)</span></span><br><span class="line">terra<span class="operator">::</span>plot<span class="punctuation">(</span>nz_elev <span class="operator">/</span> <span class="number">1000</span><span class="punctuation">,</span> add <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> axes <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">plot<span class="punctuation">(</span>st_geometry<span class="punctuation">(</span>nz<span class="punctuation">)</span><span class="punctuation">,</span> add <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/nz-plot-1.png" alt="Map of New Zealand created with plot(). The legend to the right refers to elevation (1000 m above sea level)." width="100%">
<p class="caption">
(#fig:nz-plot)Map of New Zealand created with plot(). The legend to the
right refers to elevation (1000 m above sea level).
</p>
</div>
<p>The <strong>tidyverse</strong> plotting package
<strong>ggplot2</strong> also supports <code>sf</code> objects with
<code>geom_sf()</code>. The syntax is similar to that used by
<strong>tmap</strong>: an initial <code>ggplot()</code> call is followed
by one or more layers, that are added with <code>+ geom_*()</code>,
where <code>*</code> represents a layer type such as
<code>geom_sf()</code> (for <code>sf</code> objects) or
<code>geom_points()</code> (for points).</p>
<p><strong>ggplot2</strong> plots graticules by default. The default
settings for the graticules can be overridden using
<code>scale_x_continuous()</code>, <code>scale_y_continuous()</code> or
<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/tidyverse/ggplot2/issues/2071"><code>coord_sf(datum = NA)</code></a>.
Other notable features include the use of unquoted variable names
encapsulated in <code>aes()</code> to indicate which aesthetics vary and
switching data sources using the <code>data</code> argument, as
demonstrated in the code chunk below which creates Figure
@ref(fig:nz-gg2):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">g1 <span class="operator">=</span> ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> nz<span class="punctuation">,</span> aes<span class="punctuation">(</span>fill <span class="operator">=</span> Median_income<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> nz_height<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">170</span><span class="punctuation">,</span> <span class="number">175</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">g1</span><br></pre></td></tr></table></figure>
<p>Another benefit of maps based on <strong>ggplot2</strong> is that
they can easily be given a level of interactivity when printed using the
function <code>ggplotly()</code> from the <strong>plotly</strong>
package. Try <code>plotly::ggplotly(g1)</code>, for example, and compare
the result with other <strong>plotly</strong> mapping functions
described at: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.cpsievert.me/2018/03/30/visualizing-geo-spatial-data-with-sf-and-plotly/">blog.cpsievert.me</a>.</p>
<p>An advantage of <strong>ggplot2</strong> is that it has a strong user
community and many add-on packages. It includes
<strong>ggspatial</strong>, which enhances <strong>ggplot2</strong>'s
mapping capabilities by providing options to add a north arrow
(<code>annotation_north_arrow()</code>) and a scale bar
(<code>annotation_scale()</code>), or to add background tiles
(<code>annotation_map_tile()</code>). It also accepts various spatial
data classes with <code>layer_spatial()</code>. Thus, we are able to
plot <code>SpatRaster</code> objects from <strong>terra</strong> using
this function as seen in Figure @ref(fig:nz-gg2).</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggspatial<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  layer_spatial<span class="punctuation">(</span>nz_elev<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> nz<span class="punctuation">,</span> fill <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  annotation_scale<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">170</span><span class="punctuation">,</span> <span class="number">175</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_fill_continuous<span class="punctuation">(</span>na.value <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">g1 <span class="operator">=</span> ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> nz<span class="punctuation">,</span> aes<span class="punctuation">(</span>fill <span class="operator">=</span> Median_income<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> nz_height<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">170</span><span class="punctuation">,</span> <span class="number">175</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">g1</span><br><span class="line">library<span class="punctuation">(</span>ggspatial<span class="punctuation">)</span></span><br><span class="line">ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">  layer_spatial<span class="punctuation">(</span>nz_elev<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  geom_sf<span class="punctuation">(</span>data <span class="operator">=</span> nz<span class="punctuation">,</span> fill <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  annotation_scale<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">170</span><span class="punctuation">,</span> <span class="number">175</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  scale_fill_continuous<span class="punctuation">(</span>na.value <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#&gt; Warning: Removed 1348639 rows containing missing values (`geom_raster()`).</span></span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/nz-gg2-1.png" alt="Comparison of map of New Zealand created with ggplot2 alone (left) and ggplot2 and ggspatial (right)." width="45%"><img data-src="09-mapping_files/figure-html/nz-gg2-2.png" alt="Comparison of map of New Zealand created with ggplot2 alone (left) and ggplot2 and ggspatial (right)." width="45%">
<p class="caption">
(#fig:nz-gg2)Comparison of map of New Zealand created with ggplot2 alone
(left) and ggplot2 and ggspatial (right).
</p>
</div>
<p>At the same time, <strong>ggplot2</strong> has a few drawbacks, for
example the <code>geom_sf()</code> function is not always able to create
a desired legend to use from the spatial <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/tidyverse/ggplot2/issues/2037">data</a>. Good
additional <strong>ggplot2</strong> resources can be found in the open
source <a target="_blank" rel="external nofollow noopener noreferrer" href="https://ggplot2-book.org/">ggplot2 book</a> and in the
descriptions of the multitude of '<strong>gg</strong>packages' such as
<strong>ggrepel</strong> and <strong>tidygraph</strong>.</p>
<p>We have covered mapping with <strong>sf</strong>,
<strong>terra</strong> and <strong>ggplot2</strong> first because these
packages are highly flexible, allowing for the creation of a wide range
of static maps. Before we cover mapping packages for plotting a specific
type of map (in the next paragraph), it is worth considering
alternatives to the packages already covered for general-purpose mapping
(Table @ref(tab:map-gpkg)).</p>
<table>
<caption>
(#tab:map-gpkg)Selected general-purpose mapping packages.
</caption>
<thead>
<tr>
<th style="text-align:left;">
Package
</th>
<th style="text-align:left;">
Title
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ggplot2
</td>
<td style="text-align:left;width: 9cm; ">
Create Elegant Data Visualisations Using the Grammar of Graphics
</td>
</tr>
<tr>
<td style="text-align:left;">
googleway
</td>
<td style="text-align:left;width: 9cm; ">
Accesses Google Maps APIs to Retrieve Data and Plot Maps
</td>
</tr>
<tr>
<td style="text-align:left;">
ggspatial
</td>
<td style="text-align:left;width: 9cm; ">
Spatial Data Framework for ggplot2
</td>
</tr>
<tr>
<td style="text-align:left;">
leaflet
</td>
<td style="text-align:left;width: 9cm; ">
Create Interactive Web Maps with Leaflet
</td>
</tr>
<tr>
<td style="text-align:left;">
mapview
</td>
<td style="text-align:left;width: 9cm; ">
Interactive Viewing of Spatial Data in R
</td>
</tr>
<tr>
<td style="text-align:left;">
plotly
</td>
<td style="text-align:left;width: 9cm; ">
Create Interactive Web Graphics via 'plotly.js'
</td>
</tr>
<tr>
<td style="text-align:left;">
rasterVis
</td>
<td style="text-align:left;width: 9cm; ">
Visualization Methods for Raster Data
</td>
</tr>
<tr>
<td style="text-align:left;">
tmap
</td>
<td style="text-align:left;width: 9cm; ">
Thematic Maps
</td>
</tr>
</tbody>
</table>
<p>Table @ref(tab:map-gpkg) shows a range of mapping packages are
available, and there are many others not listed in this table. Of note
is <strong>mapsf</strong>, which can generate range of geographic
visualizations including choropleth, 'proportional symbol' and 'flow'
maps. These are documented in the <a target="_blank" rel="external nofollow noopener noreferrer" href="https://cran.r-project.org/web/packages/mapsf/vignettes/mapsf.html"><code>mapsf</code></a>
vignette.</p>
<!--toDo:jn-->
<!-- recheck the list (rgdal related) -->
<p>Several packages focus on specific map types, as illustrated in Table
@ref(tab:map-spkg). Such packages create cartograms that distort
geographical space, create line maps, transform polygons into regular or
hexagonal grids, visualize complex data on grids representing geographic
topologies, and create 3D visualizations.</p>
<table>
<caption>
(#tab:map-spkg)Selected specific-purpose mapping packages, with
associated metrics.
</caption>
<thead>
<tr>
<th style="text-align:left;">
Package
</th>
<th style="text-align:left;">
Title
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
cartogram
</td>
<td style="text-align:left;">
Create Cartograms with R
</td>
</tr>
<tr>
<td style="text-align:left;">
geogrid
</td>
<td style="text-align:left;">
Turn Geospatial Polygons into Regular or Hexagonal Grids
</td>
</tr>
<tr>
<td style="text-align:left;">
geofacet
</td>
<td style="text-align:left;">
'ggplot2' Faceting Utilities for Geographical Data
</td>
</tr>
<tr>
<td style="text-align:left;">
linemap
</td>
<td style="text-align:left;">
Line Maps
</td>
</tr>
<tr>
<td style="text-align:left;">
tanaka
</td>
<td style="text-align:left;">
Design Shaded Contour Lines (or Tanaka) Maps
</td>
</tr>
<tr>
<td style="text-align:left;">
rayshader
</td>
<td style="text-align:left;">
Create Maps and Visualize Data in 2D and 3D
</td>
</tr>
</tbody>
</table>
<p>All of the aforementioned packages, however, have different
approaches for data preparation and map creation. In the next paragraph,
we focus solely on the <strong>cartogram</strong> package. Therefore, we
suggest to read the <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/rCarto/linemap">linemap</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/jbaileyh/geogrid">geogrid</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/hafen/geofacet">geofacet</a>, and <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/tylermorganwall/rayshader">rayshader</a>
documentations to learn more about them.</p>
<p>A cartogram is a map in which the geometry is proportionately
distorted to represent a mapping variable. Creation of this type of map
is possible in R with <strong>cartogram</strong>, which allows for
creating continuous and non-contiguous area cartograms. It is not a
mapping package per se, but it allows for construction of distorted
spatial objects that could be plotted using any generic mapping
package.</p>
<p>The <code>cartogram_cont()</code> function creates continuous area
cartograms. It accepts an <code>sf</code> object and name of the
variable (column) as inputs. Additionally, it is possible to modify the
<code>intermax</code> argument - maximum number of iterations for the
cartogram transformation. For example, we could represent median income
in New Zeleand's regions as a continuous cartogram (the right-hand panel
of Figure @ref(fig:cartomap1)) as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>cartogram<span class="punctuation">)</span></span><br><span class="line">nz_carto <span class="operator">=</span> cartogram_cont<span class="punctuation">(</span>nz<span class="punctuation">,</span> <span class="string">&quot;Median_income&quot;</span><span class="punctuation">,</span> itermax <span class="operator">=</span> <span class="number">5</span><span class="punctuation">)</span></span><br><span class="line">tm_shape<span class="punctuation">(</span>nz_carto<span class="punctuation">)</span> <span class="operator">+</span> tm_polygons<span class="punctuation">(</span><span class="string">&quot;Median_income&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#&gt; Warning: Some legend items or map compoments do not fit well (e.g. due to the</span><br><span class="line">#&gt; specified font size).</span><br><span class="line"></span><br><span class="line">#&gt; Warning: Some legend items or map compoments do not fit well (e.g. due to the</span><br><span class="line">#&gt; specified font size).</span><br></pre></td></tr></table></figure>
<div class="figure" style="text-align: center">
<img data-src="09-mapping_files/figure-html/cartomap1-1.png" alt="Comparison of standard map (left) and continuous area cartogram (right)." width="100%">
<p class="caption">
(#fig:cartomap1)Comparison of standard map (left) and continuous area
cartogram (right).
</p>
</div>
<p><strong>cartogram</strong> also offers creation of non-contiguous
area cartograms using <code>cartogram_ncont()</code> and Dorling
cartograms using <code>cartogram_dorling()</code>. Non-contiguous area
cartograms are created by scaling down each region based on the provided
weighting variable. Dorling cartograms consist of circles with their
area proportional to the weighting variable. The code chunk below
demonstrates creation of non-contiguous area and Dorling cartograms of
US states' population (Figure @ref(fig:cartomap2)):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">us_states2163 <span class="operator">=</span> st_transform<span class="punctuation">(</span>us_states<span class="punctuation">,</span> <span class="string">&quot;EPSG:2163&quot;</span><span class="punctuation">)</span></span><br><span class="line">us_states2163_ncont <span class="operator">=</span> cartogram_ncont<span class="punctuation">(</span>us_states2163<span class="punctuation">,</span> <span class="string">&quot;total_pop_15&quot;</span><span class="punctuation">)</span></span><br><span class="line">us_states2163_dorling <span class="operator">=</span> cartogram_dorling<span class="punctuation">(</span>us_states2163<span class="punctuation">,</span> <span class="string">&quot;total_pop_15&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<!--toDo:JN-->
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line"></span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>
<!--toDo:JN-->
<!-- update -->
<!-- New mapping packages are emerging all the time. -->
<!-- In 2018 alone, a number of mapping packages have been released on CRAN\index{CRAN}, including **mapdeck**, **mapsapi**, and **rayshader**. -->
<!-- In terms of interactive mapping, **leaflet.extras** contains many functions for extending the functionality of **leaflet** (see the end of the [`point-pattern`](https://geocompr.github.io/geocompkg/articles/point-pattern.html) vignette in the **geocompkg** website for examples of heatmaps created by **leaflet.extras**). -->
<!--toDo:JN-->
<!-- add https://github.com/riatelab/fisheye -->
<h1 id="练习">练习</h1>
<p>These exercises rely on a new object, <code>africa</code>. Create it
using the <code>world</code> and <code>worldbank_df</code> datasets from
the <strong>spData</strong> package as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>spData<span class="punctuation">)</span></span><br><span class="line">africa <span class="operator">=</span> world <span class="operator">|&gt;</span> </span><br><span class="line">  filter<span class="punctuation">(</span>continent <span class="operator">==</span> <span class="string">&quot;Africa&quot;</span><span class="punctuation">,</span> <span class="operator">!</span><span class="built_in">is.na</span><span class="punctuation">(</span>iso_a2<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  left_join<span class="punctuation">(</span>worldbank_df<span class="punctuation">,</span> by <span class="operator">=</span> <span class="string">&quot;iso_a2&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  select<span class="punctuation">(</span>name<span class="punctuation">,</span> subregion<span class="punctuation">,</span> gdpPercap<span class="punctuation">,</span> HDI<span class="punctuation">,</span> pop_growth<span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  st_transform<span class="punctuation">(</span><span class="string">&quot;ESRI:102022&quot;</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  st_make_valid<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">|&gt;</span> </span><br><span class="line">  st_collection_extract<span class="punctuation">(</span><span class="string">&quot;POLYGON&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>We will also use <code>zion</code> and <code>nlcd</code> datasets
from <strong>spDataLarge</strong>:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zion <span class="operator">=</span> read_sf<span class="punctuation">(</span><span class="punctuation">(</span>system.file<span class="punctuation">(</span><span class="string">&quot;vector/zion.gpkg&quot;</span><span class="punctuation">,</span> package <span class="operator">=</span> <span class="string">&quot;spDataLarge&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">nlcd <span class="operator">=</span> rast<span class="punctuation">(</span>system.file<span class="punctuation">(</span><span class="string">&quot;raster/nlcd.tif&quot;</span><span class="punctuation">,</span> package <span class="operator">=</span> <span class="string">&quot;spDataLarge&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>E1. Create a map showing the geographic distribution of the Human
Development Index (<code>HDI</code>) across Africa with base
<strong>graphics</strong> (hint: use <code>plot()</code>) and
<strong>tmap</strong> packages (hint: use
<code>tm_shape(africa) + ...</code>). - Name two advantages of each
based on the experience. - Name three other mapping packages and an
advantage of each. - Bonus: create three more maps of Africa using these
three other packages.</p>
<p>E2. Extend the <strong>tmap</strong> created for the previous
exercise so the legend has three bins: "High" (<code>HDI</code> above
0.7), "Medium" (<code>HDI</code> between 0.55 and 0.7) and "Low"
(<code>HDI</code> below 0.55). - Bonus: improve the map aesthetics, for
example by changing the legend title, class labels and color
palette.</p>
<p>E3. Represent <code>africa</code>'s subregions on the map. Change the
default color palette and legend title. Next, combine this map and the
map created in the previous exercise into a single plot.</p>
<p>E4. Create a land cover map of the Zion National Park. - Change the
default colors to match your perception of the land cover categories -
Add a scale bar and north arrow and change the position of both to
improve the map's aesthetic appeal - Bonus: Add an inset map of Zion
National Park's location in the context of the Utah state. (Hint: an
object representing Utah can be subset from the <code>us_states</code>
dataset.)</p>
<p>E5. Create facet maps of countries in Eastern Africa: - With one
facet showing HDI and the other representing population growth (hint:
using variables <code>HDI</code> and <code>pop_growth</code>,
respectively) - With a 'small multiple' per country</p>
<p>E6. Building on the previous facet map examples, create animated maps
of East Africa: - Showing each country in order - Showing each country
in order with a legend showing the HDI</p>
<p>E7. Create an interactive map of HDI in Africa: - With
<strong>tmap</strong> - With <strong>mapview</strong> - With
<strong>leaflet</strong> - Bonus: For each approach, add a legend (if
not automatically provided) and a scale bar</p>
<p>E8. Sketch on paper ideas for a web mapping app that could be used to
make transport or land-use policies more evidence based: - In the city
you live, for a couple of users per day - In the country you live, for
dozens of users per day - Worldwide for hundreds of users per day and
large data serving requirements</p>
<p>E9. Update the code in <code>coffeeApp/app.R</code> so that instead
of centering on Brazil the user can select which country to focus on: -
Using <code>textInput()</code> - Using <code>selectInput()</code></p>
<p>E10. Reproduce Figure 9.1 and Figure 9.7 as closely as possible using
the <strong>ggplot2</strong> package.</p>
<p>E11. Join <code>us_states</code> and <code>us_states_df</code>
together and calculate a poverty rate for each state using the new
dataset. Next, construct a continuous area cartogram based on total
population. Finally, create and compare two maps of the poverty rate:
(1) a standard choropleth map and (2) a map using the created cartogram
boundaries. What is the information provided by the first and the second
map? How do they differ from each other?</p>
<p>E12. Visualize population growth in Africa. Next, compare it with the
maps of a hexagonal and regular grid created using the
<strong>geogrid</strong> package.</p>
<aside id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>If there is a clash between a fixed value and a column
name, the column name takes precedence. This can be verified by running
the next code chunk after running <code>nz$red = 1:nrow(nz)</code>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>A fourth group of color palettes, called bivariate, also
exists. They are used when we want to represent relations between two
variables on one map.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>See the "Color vision" options and the "Color Blind
Friendliness" panel in <code>cols4all::c4a_gui()</code>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Another additional map elements include
<code>tm_grid()</code>, <code>tm_logo()</code> and
<code>tm_credits()</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>There is also a shortcut for this approach:
<code>tm_facets_pagewise()</code>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>You may also try to use
<code>mapviewOptions(georaster = TRUE)</code> for more performant
visualizations of large raster data.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>The word 'app' in this context refers to 'web
application' and should not be confused with smartphone apps, the more
common meaning of the word.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</aside>

            
        </div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/17/2023-8-17-8%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AEIO/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/17/2023-8-17-8%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AEIO/" class="post-title-link" itemprop="url">(8)地理数据 I/O</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-17 14:11:20" itemprop="dateCreated datePublished" datetime="2023-08-17T14:11:20+08:00">2023-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-04 12:10:06" itemprop="dateModified" datetime="2023-10-04T12:10:06+08:00">2023-10-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/17/2023-8-17-8%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AEIO/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/17/2023-8-17-8%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AEIO/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>10k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>37 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/read-write">第八章</a></p>
</blockquote>
<p>本章关于读取和写入地理数据。地理数据<em>输入</em>对地理计算至关重要，没有数据就不可能有真实世界的应用。数据<em>输出</em>也非常关键,它能够让其他人使用由你的工作产生的有价值的新数据集或改进后的数据集。总而言之,输入/输出这些进程可以称为数据I/O。
            <!--noindex-->
            <div class="post-button">
                <a class="btn" href="/2023/08/17/2023-8-17-8%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AEIO/#more" rel="contents">
                    阅读全文 &raquo;
                </a>
            </div>
            <!--/noindex-->
            
            
        </p></div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/16/2023-8-16-7%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E9%87%8D%E6%8A%95%E5%BD%B1/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/16/2023-8-16-7%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E9%87%8D%E6%8A%95%E5%BD%B1/" class="post-title-link" itemprop="url">(7)地理数据重投影</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-16 09:05:20" itemprop="dateCreated datePublished" datetime="2023-08-16T09:05:20+08:00">2023-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-04 12:09:21" itemprop="dateModified" datetime="2023-10-04T12:09:21+08:00">2023-10-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/16/2023-8-16-7%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E9%87%8D%E6%8A%95%E5%BD%B1/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/16/2023-8-16-7%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E9%87%8D%E6%8A%95%E5%BD%B1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>40 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/reproj-geo-data">第七章</a></p>
</blockquote>
<p>本章演示了如何设置并将地理数据从一个CRS<em>转换</em>到另一个CRS，并进一步突出了由于忽略CRS而可能出现的特定问题，当您的数据以经纬度坐标存储时，应该特别注意。
            <!--noindex-->
            <div class="post-button">
                <a class="btn" href="/2023/08/16/2023-8-16-7%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E9%87%8D%E6%8A%95%E5%BD%B1/#more" rel="contents">
                    阅读全文 &raquo;
                </a>
            </div>
            <!--/noindex-->
            
            
        </p></div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/15/2023-8-15-6%E6%A0%85%E6%A0%BC%E7%9F%A2%E9%87%8F%E4%BA%A4%E5%8F%89/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/15/2023-8-15-6%E6%A0%85%E6%A0%BC%E7%9F%A2%E9%87%8F%E4%BA%A4%E5%8F%89/" class="post-title-link" itemprop="url">(6)栅格矢量交叉</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-15 18:29:20" itemprop="dateCreated datePublished" datetime="2023-08-15T18:29:20+08:00">2023-08-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-03 01:39:35" itemprop="dateModified" datetime="2023-10-03T01:39:35+08:00">2023-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/15/2023-8-15-6%E6%A0%85%E6%A0%BC%E7%9F%A2%E9%87%8F%E4%BA%A4%E5%8F%89/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/15/2023-8-15-6%E6%A0%85%E6%A0%BC%E7%9F%A2%E9%87%8F%E4%BA%A4%E5%8F%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>18 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/raster-vector">第六章</a></p>
</blockquote>
<p>本章专注于栅格和矢量地理数据模型之间的相互作用。包括四个主要技术：使用矢量对象进行栅格裁剪和遮罩；使用不同类型的矢量数据提取栅格值；以及栅格与矢量之间的转换。以上概念使用前几章中使用的数据进行演示，以了解其潜在的现实应用。
            <!--noindex-->
            <div class="post-button">
                <a class="btn" href="/2023/08/15/2023-8-15-6%E6%A0%85%E6%A0%BC%E7%9F%A2%E9%87%8F%E4%BA%A4%E5%8F%89/#more" rel="contents">
                    阅读全文 &raquo;
                </a>
            </div>
            <!--/noindex-->
            
            
        </p></div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/14/2023-8-14-5%E5%87%A0%E4%BD%95%E6%93%8D%E4%BD%9C/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/14/2023-8-14-5%E5%87%A0%E4%BD%95%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">(5)几何操作</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-14 07:40:20" itemprop="dateCreated datePublished" datetime="2023-08-14T07:40:20+08:00">2023-08-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-03 01:32:52" itemprop="dateModified" datetime="2023-10-03T01:32:52+08:00">2023-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/14/2023-8-14-5%E5%87%A0%E4%BD%95%E6%93%8D%E4%BD%9C/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/14/2023-8-14-5%E5%87%A0%E4%BD%95%E6%93%8D%E4%BD%9C/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>34 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/geometry-operations">第五章</a></p>
</blockquote>
<p>本章重点介绍如何操作地理对象的地理元素，例如通过简化和转换矢量几何图形、裁剪栅格数据集以及将矢量对象转换为栅格并从栅格转换为矢量。阅读本章并尝试章末的练习后，你应该能理解并控制<code>sf</code>对象中的几何列，以及与其他地理对象相关的栅格中所表示像素的范围和地理位置。
            <!--noindex-->
            <div class="post-button">
                <a class="btn" href="/2023/08/14/2023-8-14-5%E5%87%A0%E4%BD%95%E6%93%8D%E4%BD%9C/#more" rel="contents">
                    阅读全文 &raquo;
                </a>
            </div>
            <!--/noindex-->
            
            
        </p></div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/13/2023-8-13-4%E7%A9%BA%E9%97%B4%E6%93%8D%E4%BD%9C/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/13/2023-8-13-4%E7%A9%BA%E9%97%B4%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">(4)空间操作</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-13 01:12:20" itemprop="dateCreated datePublished" datetime="2023-08-13T01:12:20+08:00">2023-08-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-03 01:28:09" itemprop="dateModified" datetime="2023-10-03T01:28:09+08:00">2023-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/13/2023-8-13-4%E7%A9%BA%E9%97%B4%E6%93%8D%E4%BD%9C/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/13/2023-8-13-4%E7%A9%BA%E9%97%B4%E6%93%8D%E4%BD%9C/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>48 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/spatial-operations">第四章</a></p>
</blockquote>
<p>空间操作，包括矢量数据集之间的空间连接以及栅格数据集上的局部和焦点操作，是地理计算的重要部分。本章展示了如何基于空间对象的位置和形状以多种方式进行修改。许多空间操作有与之对应的非空间（属性）操作，因此上一章中演示的如子集提取和数据集连接等概念在此也适用。
            <!--noindex-->
            <div class="post-button">
                <a class="btn" href="/2023/08/13/2023-8-13-4%E7%A9%BA%E9%97%B4%E6%93%8D%E4%BD%9C/#more" rel="contents">
                    阅读全文 &raquo;
                </a>
            </div>
            <!--/noindex-->
            
            
        </p></div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/12/2023-8-12-3%E5%B1%9E%E6%80%A7%E6%93%8D%E4%BD%9C/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/12/2023-8-12-3%E5%B1%9E%E6%80%A7%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">(3)属性操作</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-12 23:11:20" itemprop="dateCreated datePublished" datetime="2023-08-12T23:11:20+08:00">2023-08-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-03 01:27:02" itemprop="dateModified" datetime="2023-10-03T01:27:02+08:00">2023-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/12/2023-8-12-3%E5%B1%9E%E6%80%A7%E6%93%8D%E4%BD%9C/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/12/2023-8-12-3%E5%B1%9E%E6%80%A7%E6%93%8D%E4%BD%9C/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>33 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/attr">第三章</a></p>
</blockquote>
<p>本章讲授如何基于属性来操作地理对象，例如矢量数据集中的公交站名和栅格数据集中像素的高程。对于矢量数据，意味着应用例如<code>subsetting</code>和<code>aggregation</code>方法（参见矢量属性提取子集和矢量属性聚合章节）。和创建属性移除空间信息章节演示了如何通过共享<strong>ID</strong>将数据连接到简单要素对象以及如何创建新变量。这些操作都有空间等效功能：例如，基于属性和空间对象的<code>subsetting</code>操作都可以使用R中的<code>[</code>运算符；您还可以使用<code>spatial joins</code>将两个地理数据集的属性进行连接。本章所培养的技能具有交叉传递性。<em>空间数据操作</em>章节将本章介绍的方法扩展到空间方面。
            <!--noindex-->
            <div class="post-button">
                <a class="btn" href="/2023/08/12/2023-8-12-3%E5%B1%9E%E6%80%A7%E6%93%8D%E4%BD%9C/#more" rel="contents">
                    阅读全文 &raquo;
                </a>
            </div>
            <!--/noindex-->
            
            
        </p></div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




    


<div class="post-block">
    
    

    <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
        <link itemprop="mainEntityOfPage" href="https://ancao96.github.io/2023/08/11/2023-8-11-2%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE/">

        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="image" content="/images/avatar.gif">
            <meta itemprop="name" content="SCY">
        </span>

        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
            <meta itemprop="name" content="SCY SPACE">
            <meta itemprop="description" content>
        </span>

        <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="name" content="undefined | SCY SPACE">
            <meta itemprop="description" content>
        </span>
        <header class="post-header">
            <h2 class="post-title" itemprop="name headline">
                <a href="/2023/08/11/2023-8-11-2%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE/" class="post-title-link" itemprop="url">(2)R中的地理数据</a>
            </h2>

            <div class="post-meta-container">
                <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-11 12:37:20" itemprop="dateCreated datePublished" datetime="2023-08-11T12:37:20+08:00">2023-08-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-06 20:03:19" itemprop="dateModified" datetime="2023-09-06T20:03:19+08:00">2023-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/" itemprop="url" rel="index"><span itemprop="name">R</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/R/Geocomputaion/" itemprop="url" rel="index"><span itemprop="name">Geocomputaion</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/08/11/2023-8-11-2%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/08/11/2023-8-11-2%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>16k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>57 分钟</span>
    </span>
</div>

            </div>
        </header>

        
        
        
        <div class="post-body" itemprop="articleBody">
            <blockquote><p>本文由SCY翻译自《Geocomputation with R》<a target="_blank" rel="external nofollow noopener noreferrer" href="https://r.geocompx.org/spatial-class#spatial-class">第二章</a></p>
</blockquote>
<h1 id="r中的地理数据">R中的地理数据</h1>
<p>本章将简要介绍两种基本的地理数据模型：矢量和栅格。我们将介绍每种数据模型背后的理论以及它们在哪些学科中占主导地位,然后演示它们在R中的实现。</p>
            <!--noindex-->
            <div class="post-button">
                <a class="btn" href="/2023/08/11/2023-8-11-2%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE/#more" rel="contents">
                    阅读全文 &raquo;
                </a>
            </div>
            <!--/noindex-->
            
            
        </div>

        
        
        

        <div>
            
        </div>

        <footer class="post-footer">
            <div class="post-eof"></div>
            
        </footer>
    </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
    </main>
    <footer class="footer">
      <div class="footer-inner">

<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">178k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">10:47</span>
  </span>
</div>
<div class="busuanzi-count">
</div>

<!-- 删除 “由 Hexo & NexT.Gemini 强力驱动” -->
<!-- -->

      </div>
    </footer>
    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.20/fancybox/fancybox.umd.js" integrity="sha256-q8XkJ6dj5VwSvzI8+nATCHHQG+Xv/dAZBCgqmu93zOY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.19.1/algoliasearch-lite.umd.js" integrity="sha256-qzlNbRtZWHoUV5I2mI2t9QR7oYXlS9oNctX+0pECXI0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.56.8/instantsearch.production.min.js" integrity="sha256-xUys6KCuRGBxFaRaYZlWulRUjY48XFv6/Q2s0mb1dmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>
<script class="next-config" data-name="chatra" type="application/json">{"enable":true,"async":true,"id":null}</script>
<script src="/js/third-party/chat/chatra.js"></script>
<script async src="https://call.chatra.io/chatra.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js","integrity":"sha256-g2xji1rlE3KsGVClvuxTbcR0Kn2+wtQADSff2Tbb4zA="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.3.0/wavedrom.min.js","integrity":"sha256-IRMDzTC+wK5stMucZ/XSXkeS5VNtxZ+/Bm8Mcqfoxdo="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.3.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>

  <script src="/js/third-party/fancybox.js"></script>


  <script src="/js/third-party/addtoany.js"></script>

    
  <script data-pjax async src="/js/busuanzi.js"></script>



  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://ancao96.github.io/page/2/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://waline-server-nxpj3ksyo-scy.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"请文明评论呀~","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":["nick","mail"],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","eemoji":["https://unpkg.com/@waline/emojis@1.1.0/tw-emoji","//unpkg.com/@waline/emojis@1.1.0/bilibili","//unpkg.com/@waline/emojis@1.1.0/alus","https://unpkg.com/@waline/emojis@1.1.0/weibo"],"el":"#waline","comment":true,"path":"/page/2/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

    <link rel="stylesheet" href="/dist/APlayer.min.css">
    <div id="aplayer"></div>
    <script type="text/javascript" src="/dist/APlayer.min.js"></script>
    <script type="text/javascript" src="/dist/music.js"></script>
    
  </body>
</html>
